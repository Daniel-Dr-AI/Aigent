# ============================================================================
# Aigent Module 08 - Enhanced Messaging Omnichannel Hub (PHI-SENSITIVE)
# Environment Variables Template
# Version: 1.1.0-enhanced
# PHI Level: HIGH
# ============================================================================
#
# ⚠️ SECURITY WARNING: This module handles patient messages containing PHI
# All configuration must comply with HIPAA Security Rule requirements
#
# INSTRUCTIONS:
# 1. Copy this file to your n8n environment configuration
# 2. Replace all placeholder values with your actual credentials/settings
# 3. NEVER commit the actual .env file to version control
# 4. Ensure BAA (Business Associate Agreement) with all messaging providers
# 5. Enable PHI masking for conversation logs
# 6. Enable audit logging for all message access
#
# ============================================================================

# ----------------------------------------------------------------------------
# CORE WEBHOOK CONFIGURATION
# ----------------------------------------------------------------------------

# Webhook unique identifier
WEBHOOK_ID_MODULE_08=messaging-hub-v1

# CORS allowed origins (restrictive for PHI security)
ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com

# ----------------------------------------------------------------------------
# SUPPORTED MESSAGING CHANNELS
# ----------------------------------------------------------------------------

# Enable channels (set to true/false)
ENABLE_SMS=true
ENABLE_WHATSAPP=true
ENABLE_EMAIL=true
ENABLE_TELEGRAM=false
ENABLE_WEBCHAT=true

# ----------------------------------------------------------------------------
# TWILIO SMS CONFIGURATION
# ----------------------------------------------------------------------------

# Twilio Credential ID
TWILIO_CREDENTIAL_ID=8

# Twilio Credential Name
TWILIO_CREDENTIAL_NAME=Twilio SMS Production

# Twilio phone number (clinic's SMS number)
TWILIO_FROM_NUMBER=+15551234567

# Twilio webhook for incoming SMS
# Twilio should POST to: https://your-n8n.com/webhook/messaging-hub-v1
TWILIO_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/messaging-hub-v1

# SMS retry configuration
SMS_RETRY_COUNT=2
SMS_RETRY_DELAY_MS=500

# ⚠️ HIPAA COMPLIANCE: Ensure Twilio account has BAA signed
# https://www.twilio.com/en-us/legal/tos

# ----------------------------------------------------------------------------
# TWILIO WHATSAPP CONFIGURATION
# ----------------------------------------------------------------------------

# WhatsApp phone number (must be registered with Twilio)
WHATSAPP_FROM_NUMBER=+15551234567

# WhatsApp webhook for incoming messages
# Same webhook as SMS (Twilio handles both)
WHATSAPP_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/messaging-hub-v1

# WhatsApp approved templates (for outbound)
# Template IDs must be pre-approved by WhatsApp
WHATSAPP_TEMPLATES=appointment_reminder,booking_confirmation,session_link

# ----------------------------------------------------------------------------
# SENDGRID EMAIL CONFIGURATION
# ----------------------------------------------------------------------------

# SendGrid Credential ID
SENDGRID_CREDENTIAL_ID=11

# SendGrid Credential Name
SENDGRID_CREDENTIAL_NAME=SendGrid Production API

# SendGrid from email
SENDGRID_FROM_EMAIL=messages@yourclinic.com

# SendGrid from name
SENDGRID_FROM_NAME=Your Clinic Team

# SendGrid inbound webhook
# Configure SendGrid to POST inbound emails to this endpoint
SENDGRID_INBOUND_WEBHOOK=https://n8n.yourclinic.com/webhook/messaging-hub-v1

# Email retry configuration
EMAIL_RETRY_COUNT=2
EMAIL_RETRY_DELAY_MS=500

# ⚠️ HIPAA COMPLIANCE: Ensure SendGrid account has BAA signed
# https://sendgrid.com/resource/sendgrid-hipaa-compliance/

# ----------------------------------------------------------------------------
# TELEGRAM CONFIGURATION (If enabled)
# ----------------------------------------------------------------------------

# Telegram Bot Token (from @BotFather)
TELEGRAM_BOT_TOKEN=your-telegram-bot-token

# Telegram webhook
# Set webhook via: https://api.telegram.org/bot<token>/setWebhook?url=<webhook_url>
TELEGRAM_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/messaging-hub-v1

# ⚠️ SECURITY NOTE: Telegram is NOT HIPAA-compliant
# Use ONLY for non-PHI communications (appointment reminders, general inquiries)

# ----------------------------------------------------------------------------
# WEBCHAT CONFIGURATION (If enabled)
# ----------------------------------------------------------------------------

# Webchat widget endpoint
WEBCHAT_ENDPOINT=https://n8n.yourclinic.com/webhook/messaging-hub-v1

# Webchat CORS origins (for browser embed)
WEBCHAT_ALLOWED_ORIGINS=https://yourclinic.com,https://www.yourclinic.com

# Webchat session timeout (minutes)
WEBCHAT_SESSION_TIMEOUT=30

# ⚠️ WEBCHAT SECURITY:
# - Embed only on HTTPS domains
# - Implement CAPTCHA to prevent abuse
# - Rate limit per IP address

# ----------------------------------------------------------------------------
# MESSAGE NORMALIZATION
# ----------------------------------------------------------------------------

# Enable message normalization
# Converts all channels to unified format
ENABLE_MESSAGE_NORMALIZATION=true

# Preserve original message format
# Store raw input for debugging
PRESERVE_RAW_MESSAGE=true

# ----------------------------------------------------------------------------
# INTENT CLASSIFICATION
# ----------------------------------------------------------------------------

# Enable intent detection
ENABLE_INTENT_DETECTION=true

# Intent categories
# Options: booking, billing, urgent, support, general
INTENT_CATEGORIES=booking,billing,urgent,support,general

# Intent classification confidence threshold (0.0-1.0)
INTENT_CONFIDENCE_THRESHOLD=0.7

# Booking intent keywords
BOOKING_KEYWORDS=book,schedule,appointment,reschedule,cancel,available,slot

# Billing intent keywords
BILLING_KEYWORDS=payment,bill,invoice,charge,refund,receipt,cost,price

# Urgent intent keywords
URGENT_KEYWORDS=urgent,emergency,pain,bleeding,severe,critical,help

# Support intent keywords
SUPPORT_KEYWORDS=question,help,how,what,when,where,information

# Default intent (if confidence below threshold)
DEFAULT_INTENT=general

# ----------------------------------------------------------------------------
# AIGENT BOT INTEGRATION
# ----------------------------------------------------------------------------

# Enable AIgent Bot auto-response
ENABLE_AIGENT_BOT=true

# AIgent Bot API endpoint
AIGENT_BOT_API_URL=https://api.aigent.company/v1/chat

# AIgent Bot API Key
AIGENT_BOT_API_KEY=your-aigent-bot-api-key

# AIgent Bot model
# Options: gpt-4, gpt-3.5-turbo, claude-3-opus, claude-3-sonnet
AIGENT_BOT_MODEL=gpt-4

# AIgent Bot system prompt
AIGENT_BOT_SYSTEM_PROMPT=You are a helpful medical clinic assistant. Provide friendly, professional responses. NEVER provide medical advice. For urgent matters, direct patients to call 911 or visit the ER.

# AIgent Bot API timeout (milliseconds)
AIGENT_BOT_TIMEOUT_MS=10000

# AIgent Bot retry configuration
AIGENT_BOT_RETRY_COUNT=2
AIGENT_BOT_RETRY_DELAY_MS=1000

# ⚠️ HIPAA COMPLIANCE: Ensure bot provider has BAA signed
# Bot should NOT diagnose, prescribe, or provide medical advice

# ----------------------------------------------------------------------------
# BUSINESS HOURS & ROUTING
# ----------------------------------------------------------------------------

# Business hours (for auto-response routing)
BUSINESS_HOURS_START=08:00
BUSINESS_HOURS_END=18:00
BUSINESS_DAYS=1,2,3,4,5

# Timezone
TIMEZONE=America/New_York

# After-hours auto-response
AFTER_HOURS_AUTO_RESPONSE=Thank you for your message. Our office is currently closed. We'll respond when we open at 8 AM. For urgent matters, please call 911.

# After-hours urgent escalation
# Send urgent messages to on-call staff even after hours
ESCALATE_URGENT_AFTER_HOURS=true

# On-call phone number
ON_CALL_PHONE=+15559876543

# On-call email
ON_CALL_EMAIL=oncall@yourclinic.com

# ----------------------------------------------------------------------------
# SPAM DETECTION & RATE LIMITING
# ----------------------------------------------------------------------------

# Enable spam detection
ENABLE_SPAM_DETECTION=true

# Spam keywords (case-insensitive, comma-separated)
SPAM_KEYWORDS=viagra,cialis,lottery,winner,click here,free money,casino

# Rate limiting (messages per hour per sender)
RATE_LIMIT_PER_HOUR=10

# Rate limit action
# Options: block, warn, throttle
RATE_LIMIT_ACTION=throttle

# Block sender after violations
BLOCK_AFTER_VIOLATIONS=3

# ⚠️ SPAM PROTECTION:
# - Implement CAPTCHA for webchat
# - Monitor for suspicious patterns (rapid-fire messages)
# - Maintain blocklist for known spam numbers/emails

# ----------------------------------------------------------------------------
# PHI MASKING FOR LOGS (HIPAA Critical)
# ----------------------------------------------------------------------------

# Enable PHI masking in conversation logs
ENABLE_PHI_MASKING=true

# PHI masking level (1-3)
# 1 = Preserve last 4 digits (phone, IDs)
# 2 = Preserve last 2 digits
# 3 = Complete redaction
PHI_MASKING_LEVEL=2

# Mask patient identifiers in logs
MASK_PHONE_IN_LOGS=true
MASK_EMAIL_IN_LOGS=true
MASK_NAME_IN_LOGS=false

# Redact sensitive content from message preview
# Truncate message preview to N characters
MESSAGE_PREVIEW_MAX_LENGTH=200

# Redact SSN from messages
REDACT_SSN_IN_LOGS=true

# Redact credit card numbers
REDACT_CC_IN_LOGS=true

# Redact MRN/Patient IDs
REDACT_MRN_IN_LOGS=true

# ⚠️ PHI MASKING STRATEGY:
# Always mask PHI in logs, notifications, and staff previews
# Store original unmasked message in encrypted HIPAA-compliant storage
# Audit all access to unmasked messages

# ----------------------------------------------------------------------------
# CRM INTEGRATION (HubSpot Default)
# ----------------------------------------------------------------------------

# HubSpot Credential ID
HUBSPOT_CREDENTIAL_ID=1

# HubSpot Credential Name
HUBSPOT_CREDENTIAL_NAME=HubSpot Production Account

# Log conversations to CRM
LOG_CONVERSATIONS_TO_CRM=true

# Create contact if not exists
CRM_CREATE_CONTACT_IF_NEW=true

# Update contact last message timestamp
CRM_UPDATE_LAST_MESSAGE_TIME=true

# CRM custom property mapping
CRM_PROPERTY_LAST_MESSAGE=last_message_date
CRM_PROPERTY_MESSAGE_CHANNEL=preferred_channel
CRM_PROPERTY_MESSAGE_COUNT=total_messages

# CRM retry configuration
CRM_RETRY_COUNT=3
CRM_RETRY_DELAY_MS=1000

# ----------------------------------------------------------------------------
# CONVERSATION LOGGING (Google Sheets / Airtable)
# ----------------------------------------------------------------------------

# Google Sheets Credential ID
GOOGLE_SHEETS_CREDENTIAL_ID=6

# Spreadsheet ID
GOOGLE_SHEET_ID=your-spreadsheet-id

# Sheet tab name for message log
GOOGLE_SHEET_TAB_MESSAGES=Messages

# Log message preview (redacted)
LOG_MESSAGE_PREVIEW=true

# Airtable Configuration (Alternative)
# AIRTABLE_CREDENTIAL_ID=16
# AIRTABLE_BASE_ID=your-base-id
# AIRTABLE_TABLE_NAME=Messages

# ----------------------------------------------------------------------------
# STAFF NOTIFICATIONS
# ----------------------------------------------------------------------------

# Enable staff notifications for new messages
ENABLE_STAFF_NOTIFICATIONS=true

# Notification channels
NOTIFY_VIA_SLACK=true
NOTIFY_VIA_EMAIL=true
NOTIFY_VIA_SMS=false

# Slack webhook for staff notifications
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T.../B.../XXX...
SLACK_CHANNEL=#patient-messages

# Email notifications
STAFF_NOTIFICATION_EMAIL=staff@yourclinic.com

# SMS notifications (Twilio)
# STAFF_NOTIFICATION_PHONE=+15559876543

# Notification frequency
# Options: realtime, hourly, daily
NOTIFICATION_FREQUENCY=realtime

# Suppress notifications for auto-responses
SUPPRESS_BOT_NOTIFICATIONS=true

# ⚠️ PHI IN NOTIFICATIONS:
# NEVER include full message content in notifications
# Use masked preview: "New message from J*** D*** (***-***-4567)"

# ----------------------------------------------------------------------------
# AUTO-RESPONSE CONFIGURATION
# ----------------------------------------------------------------------------

# Enable auto-response for common intents
ENABLE_AUTO_RESPONSE=true

# Auto-response for booking intent
AUTO_RESPONSE_BOOKING=To book an appointment, please visit: https://yourclinic.com/book or reply BOOK.

# Auto-response for billing intent
AUTO_RESPONSE_BILLING=For billing questions, please call (555) 123-4567 or email billing@yourclinic.com.

# Auto-response for general intent
AUTO_RESPONSE_GENERAL=Thank you for your message. A team member will respond within 1 business hour.

# Auto-response for urgent intent
AUTO_RESPONSE_URGENT=We've received your urgent message and will respond immediately. For life-threatening emergencies, please call 911.

# Disable auto-response during business hours (human takes over)
AUTO_RESPONSE_BUSINESS_HOURS_ONLY=false

# ----------------------------------------------------------------------------
# MESSAGE DELIVERY TRACKING
# ----------------------------------------------------------------------------

# Enable delivery tracking
ENABLE_DELIVERY_TRACKING=true

# Track delivery status
# Options: sent, delivered, read, failed
TRACK_DELIVERY_STATUS=true

# Track read receipts (if channel supports)
TRACK_READ_RECEIPTS=true

# Retry failed messages
RETRY_FAILED_MESSAGES=true
MESSAGE_RETRY_COUNT=2
MESSAGE_RETRY_DELAY_MS=1000

# ----------------------------------------------------------------------------
# PERFORMANCE TUNING
# ----------------------------------------------------------------------------

# Workflow execution timeout (milliseconds)
WORKFLOW_TIMEOUT_MS=60000

# Maximum parallel executions
# Messaging can process concurrently
MAX_PARALLEL_EXECUTIONS=10

# API timeout configurations (milliseconds)
TWILIO_API_TIMEOUT_MS=5000
SENDGRID_API_TIMEOUT_MS=5000
TELEGRAM_API_TIMEOUT_MS=5000
AIGENT_BOT_API_TIMEOUT_MS=10000
CRM_API_TIMEOUT_MS=10000

# Target execution time (milliseconds)
# Module 08 target: <2000ms (real-time messaging)
TARGET_EXECUTION_TIME_MS=2000

# ----------------------------------------------------------------------------
# OBSERVABILITY & MONITORING
# ----------------------------------------------------------------------------

# Enable debug mode
DEBUG_MODE=false

# Save execution data
SAVE_EXECUTION_DATA=all

# Support email
SUPPORT_EMAIL=support@yourclinic.com

# Workflow version
WORKFLOW_VERSION=1.1.0-enhanced

# Enable performance tracking
ENABLE_PERFORMANCE_TRACKING=true

# Enable audit logging
AUDIT_LOG_ENABLED=true

# Module 09 (Audit) webhook URL
MODULE_09_AUDIT_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/aigent-audit-log

# ----------------------------------------------------------------------------
# SECURITY & COMPLIANCE (HIPAA CRITICAL)
# ----------------------------------------------------------------------------

# HIPAA mode
HIPAA_MODE=true

# Encryption at rest
# All stored messages must be encrypted
ENABLE_ENCRYPTION_AT_REST=true

# Data retention period (days)
# HIPAA: 6 years minimum (2190 days)
DATA_RETENTION_DAYS=2555

# Message expiration (days)
# Delete messages after N days
MESSAGE_EXPIRATION_DAYS=2555

# Audit all message access
AUDIT_MESSAGE_ACCESS=true

# ⚠️ HIPAA COMPLIANCE CHECKLIST:
# [ ] BAA signed with Twilio (SMS, WhatsApp)
# [ ] BAA signed with SendGrid (Email)
# [ ] BAA signed with bot provider (if using AIgent Bot)
# [ ] PHI masking enabled for logs (ENABLE_PHI_MASKING=true)
# [ ] Encryption at rest enabled
# [ ] Encryption in transit (HTTPS/TLS)
# [ ] Access controls configured
# [ ] Audit logging enabled
# [ ] Data retention policy configured
# [ ] Staff trained on PHI handling in messages

# ----------------------------------------------------------------------------
# INTEGRATION WITH OTHER MODULES
# ----------------------------------------------------------------------------

# Module 01 (Lead Capture) webhook
# Send new leads from messaging to lead capture
MODULE_01_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/intake-lead

# Module 02 (Booking) webhook
# Send booking requests to booking module
MODULE_02_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/consult-booking

# Module 03 (Telehealth) webhook
# Send session-related messages
MODULE_03_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/telehealth-session

# Module 04 (Billing) webhook
# Send billing inquiries
MODULE_04_WEBHOOK_URL=https://n8n.yourclinic.com/webhook/billing-payment

# Module 07 (Analytics) ingestion
MODULE_07_ANALYTICS_API=https://n8n.yourclinic.com/webhook/07-analytics-ingest

# ----------------------------------------------------------------------------
# ADVANCED FEATURES (Optional)
# ----------------------------------------------------------------------------

# Enable sentiment analysis
# Detect patient satisfaction from message tone
ENABLE_SENTIMENT_ANALYSIS=false

# Sentiment API endpoint
# SENTIMENT_API_URL=https://api.example.com/sentiment

# Enable translation
# Translate messages to/from patient's preferred language
ENABLE_TRANSLATION=false

# Translation service
# Options: google_translate, deepl
# TRANSLATION_SERVICE=google_translate

# Target languages (comma-separated)
# TRANSLATION_LANGUAGES=es,zh,ar,vi

# Enable message templates
# Pre-defined responses for common questions
ENABLE_MESSAGE_TEMPLATES=true

# Template storage
# TEMPLATE_SHEET_ID=your-template-sheet-id

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
#
# SECURITY CHECKLIST:
# [ ] All messaging providers configured with BAAs signed
# [ ] PHI masking enabled (ENABLE_PHI_MASKING=true)
# [ ] Business hours configured
# [ ] Auto-responses configured
# [ ] Spam detection enabled
# [ ] Rate limiting enabled
# [ ] Staff notifications configured with masked previews
# [ ] CRM integration tested
# [ ] Conversation logging tested
# [ ] Audit logging enabled
#
# TESTING CHECKLIST:
# [ ] Test SMS inbound/outbound (Twilio)
# [ ] Test WhatsApp inbound/outbound (Twilio)
# [ ] Test email inbound/outbound (SendGrid)
# [ ] Test webchat (if enabled)
# [ ] Test intent classification (booking, billing, urgent, support, general)
# [ ] Test auto-responses for each intent
# [ ] Test after-hours auto-response
# [ ] Test urgent escalation after hours
# [ ] Test spam detection (spam keywords)
# [ ] Test rate limiting (send 11+ messages in 1 hour)
# [ ] Test PHI masking in logs (SSN, CC, MRN)
# [ ] Test staff notifications (Slack, email)
# [ ] Test CRM logging (contact creation, message tracking)
# [ ] Test AIgent Bot integration (if enabled)
# [ ] Verify no PHI in notifications
# [ ] Test message delivery tracking
#
# MONITORING CHECKLIST:
# [ ] Monitor message volume by channel (SMS, WhatsApp, email)
# [ ] Monitor intent classification accuracy
# [ ] Monitor auto-response effectiveness (fewer escalations)
# [ ] Monitor response time (<2000ms P95)
# [ ] Monitor bot success rate (messages resolved by bot)
# [ ] Monitor spam detection (blocked messages)
# [ ] Monitor rate limit violations
# [ ] Track business hours vs after-hours volume
# [ ] Review urgent escalations (false positives/negatives)
# [ ] Monitor CRM sync success rate
# [ ] Track staff response times
#
# OPERATIONAL CHECKLIST:
# [ ] Train staff on messaging platform access
# [ ] Document response time SLA (e.g., 1 hour business hours)
# [ ] Establish on-call rotation for after-hours urgent messages
# [ ] Create message templates for common questions
# [ ] Review and update intent keywords quarterly
# [ ] Monitor patient satisfaction (sentiment analysis)
# [ ] Document escalation procedures for urgent messages
# [ ] Review spam detection accuracy (tune keywords)
# [ ] Update auto-responses based on patient feedback
#
# For support: support@aigent.company
# Documentation: https://docs.aigent.company/templates/module-08-enhanced
# ============================================================================
