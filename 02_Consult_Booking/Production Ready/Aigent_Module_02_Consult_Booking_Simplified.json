{
  "name": "Aigent_Module_02_Consult_Booking_Simplified",
  "nodes": [
    {
      "parameters": {},
      "id": "marker-validation-start",
      "name": "‚îÅ‚îÅ‚îÅ 02a: VALIDATION SEGMENT ‚îÅ‚îÅ‚îÅ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [200, 300],
      "notes": "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nSEGMENT: 02a - VALIDATION\n\nPURPOSE: Request validation, rate limiting, deduplication\n\nFLOW:\n1. Webhook entry\n2. Rate limiting check\n3. Idempotency check  \n4. Field validation (native nodes)\n5. Data sanitization\n6. Phone normalization (regex)\n\nOUTPUT: Clean, validated booking request\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "consult-booking",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "={{$vars.ALLOWED_ORIGINS}}"
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook: Booking Request",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [400, 300],
      "notes": "ENTRY POINT: Accepts booking requests\nSIMPLIFIED: Uses $vars for CORS\nSECURITY: No wildcard default - ALLOWED_ORIGINS must be set"
    },
    {
      "parameters": {
        "jsCode": "// SIMPLIFIED: Minimal rate limiting with $vars storage\nconst rateLimits = $vars.rate_limits || {};\nconst clientIP = $input.first().json.headers?.['x-forwarded-for']?.split(',')[0]?.trim() || 'unknown';\nconst now = Date.now();\nconst windowMs = 60000;\nconst maxRequests = parseInt($vars.RATE_LIMIT_MAX) || 10;\n\n// Clean old entries\nObject.keys(rateLimits).forEach(ip => {\n  if (now - (rateLimits[ip]?.windowStart || 0) > windowMs * 2) delete rateLimits[ip];\n});\n\n// Check rate\nif (!rateLimits[clientIP]) {\n  rateLimits[clientIP] = { count: 1, windowStart: now };\n} else if (now - rateLimits[clientIP].windowStart < windowMs) {\n  if (++rateLimits[clientIP].count > maxRequests) {\n    $vars.rate_limits = rateLimits;\n    throw new Error(JSON.stringify({ error: 'RATE_LIMIT_EXCEEDED', retry_after: Math.ceil((windowMs - (now - rateLimits[clientIP].windowStart)) / 1000) }));\n  }\n} else {\n  rateLimits[clientIP] = { count: 1, windowStart: now };\n}\n\n$vars.rate_limits = rateLimits;\nreturn { ...($input.first().json), client_ip: clientIP, rate_check_passed: true };"
      },
      "id": "rate-limit",
      "name": "Rate Limit Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 300],
      "notes": "CODE NODE 1/8: Rate limiting\nSIMPLIFIED: Minimal code, uses $vars for storage\nTODO: Migrate to Redis for production scale\nLIMIT: 10 req/min per IP (configurable via $vars.RATE_LIMIT_MAX)"
    },
    {
      "parameters": {
        "jsCode": "// SIMPLIFIED: Idempotency check with $vars cache\nconst headers = $input.first().json.headers || {};\nconst idempotencyKey = headers['idempotency-key'] || headers['Idempotency-Key'];\n\nif (!idempotencyKey) {\n  return { ...($input.first().json), idempotency_key: null, is_cached: false };\n}\n\nconst cache = $vars.idempotency_cache || {};\nconst now = Date.now();\n\n// Clean cache (24h TTL)\nObject.keys(cache).forEach(key => {\n  if (now - cache[key].timestamp > 86400000) delete cache[key];\n});\n\nif (cache[idempotencyKey]) {\n  throw new Error(JSON.stringify({ is_duplicate: true, cached_response: cache[idempotencyKey].response }));\n}\n\n$vars.idempotency_cache = cache;\nreturn { ...($input.first().json), idempotency_key: idempotencyKey, is_cached: false };"
      },
      "id": "idempotency-check",
      "name": "Idempotency Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 300],
      "notes": "CODE NODE 2/8: Idempotency\nSIMPLIFIED: Uses $vars.idempotency_cache\nTODO: Migrate to Redis for production scale\nCACHE: 24 hour TTL"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "email-check",
              "leftValue": "={{ $json.body.email }}",
              "rightValue": "@",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "name-check",
              "leftValue": "={{ ($json.body.name || '').trim().length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "phone-check",
              "leftValue": "={{ ($json.body.phone || '').replace(/\\D/g, '').length }}",
              "rightValue": 7,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "validate-required",
      "name": "Validate Required Fields",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 300],
      "notes": "NATIVE NODE: Field validation (no code!)\nCHECKS:\n- Email contains @\n- Name ‚â• 2 characters\n- Phone ‚â• 7 digits\nSIMPLIFIED: Replaced complex Code node with native IF"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": false,\n  \"error\": \"Validation failed\",\n  \"error_code\": \"VALIDATION_FAILED\",\n  \"details\": [\n    (!$json.body.email || !$json.body.email.includes('@')) ? 'email: required and must contain @' : null,\n    (!$json.body.name || $json.body.name.trim().length < 2) ? 'name: minimum 2 characters' : null,\n    (!$json.body.phone || $json.body.phone.replace(/\\\\D/g, '').length < 7) ? 'phone: minimum 7 digits' : null\n  ].filter(e => e !== null),\n  \"trace_id\": \"BOOK-\" + $now.toMillis(),\n  \"timestamp\": $now.toISO()\n} }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "error-validation",
      "name": "Return: Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1200, 450],
      "notes": "ERROR RESPONSE: 400 Bad Request\nNATIVE NODE: No code, just expressions\nRETURNS: Detailed field errors"
    },
    {
      "parameters": {
        "mode": "remove",
        "fields": {
          "fields": [
            {
              "fieldName": "body.name",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "sanitize-html",
      "name": "Sanitize HTML Characters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1200, 300],
      "notes": "NATIVE NODE: HTML sanitization\nREMOVED: Complex sanitization code\nSIMPLIFIED: Let n8n handle escaping in expressions\nNOTE: Use {{ }} expressions with proper escaping in email templates"
    },
    {
      "parameters": {
        "operation": "removeAll",
        "search": "[^0-9+]",
        "sourceField": "={{ $json.body.phone }}",
        "destinationField": "phone_normalized",
        "options": {}
      },
      "id": "normalize-phone-1",
      "name": "Extract Phone Digits",
      "type": "n8n-nodes-base.stringOperations",
      "typeVersion": 1,
      "position": [1400, 300],
      "notes": "NATIVE NODE: Phone normalization step 1\nREPLACED: Code node with regex operations\nACTION: Remove all non-digits (except +)"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "phone_normalized",
              "value": "={{ $json.phone_normalized.startsWith('+') ? $json.phone_normalized : ($json.phone_normalized.length === 10 ? '+1' + $json.phone_normalized : '+' + $json.phone_normalized) }}"
            },
            {
              "name": "phone_display",
              "value": "={{ $json.body.phone }}"
            },
            {
              "name": "email",
              "value": "={{ ($json.body.email || '').toLowerCase().trim() }}"
            },
            {
              "name": "name",
              "value": "={{ ($json.body.name || '').trim() }}"
            },
            {
              "name": "service_type",
              "value": "={{ ($json.body.service_type || 'Consultation').trim() }}"
            },
            {
              "name": "timezone",
              "value": "={{ $json.body.timezone || $vars.CLINIC_TIMEZONE || 'America/New_York' }}"
            },
            {
              "name": "preferred_date",
              "value": "={{ $json.body.preferred_date || null }}"
            },
            {
              "name": "preferred_time",
              "value": "={{ $json.body.preferred_time || null }}"
            },
            {
              "name": "notes",
              "value": "={{ $json.body.notes || '' }}"
            },
            {
              "name": "trace_id",
              "value": "=BOOK-{{ $now.toMillis() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "set-validated-data",
      "name": "Set Validated Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1600, 300],
      "notes": "NATIVE NODE: Data normalization\nREPLACED: Multiple Code nodes\nSETS: All validated, normalized booking fields\nADDS: trace_id for tracking"
    },
    {
      "parameters": {},
      "id": "marker-scheduling-start",
      "name": "‚îÅ‚îÅ‚îÅ 02b: SCHEDULING SEGMENT ‚îÅ‚îÅ‚îÅ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1800, 300],
      "notes": "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nSEGMENT: 02b - SCHEDULING\n\nPURPOSE: Check availability, select slot, create booking\n\nFLOW:\n1. Query scheduling API for available slots\n2. Select best slot (preference-based)\n3. Check for duplicates\n4. Create booking in calendar\n\nOUTPUT: Confirmed booking with appointment_id\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$vars.SCHEDULING_API_BASE_URL}}/availability",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "eventTypeId",
              "value": "={{$vars.SCHEDULING_EVENT_TYPE_ID}}"
            },
            {
              "name": "startTime",
              "value": "={{ $json.preferred_date ? $json.preferred_date + 'T00:00:00' : $now.plus({days: 1}).toISO() }}"
            },
            {
              "name": "endTime",
              "value": "={{ $json.preferred_date ? $now.constructor.fromISO($json.preferred_date).plus({days: 7}).toISO() : $now.plus({days: 8}).toISO() }}"
            },
            {
              "name": "timeZone",
              "value": "={{$json.timezone}}"
            }
          ]
        },
        "options": {
          "timeout": "={{parseInt($vars.CALENDAR_API_TIMEOUT) || 10000}}"
        }
      },
      "id": "check-availability",
      "name": "Check Calendar Availability",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 300],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 1000,
      "notes": "NATIVE NODE: Scheduling API call\nCONFIG: Uses $vars for API base URL\nRETRY: 3 attempts with 1s delay\nTIMEOUT: Configurable via $vars.CALENDAR_API_TIMEOUT"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 3/8: Slot selection (minimal logic)\nconst slots = $input.first().json.slots || [];\n\nif (slots.length === 0) {\n  return { error: true, error_code: 'NO_AVAILABILITY', message: 'No available slots' };\n}\n\nconst preferredTime = $input.first().json.preferred_time;\nlet selected = slots[0];\n\nif (preferredTime) {\n  const preferred = new Date($input.first().json.preferred_date + 'T' + preferredTime).getTime();\n  selected = slots.reduce((best, slot) => \n    Math.abs(new Date(slot.time).getTime() - preferred) < Math.abs(new Date(best.time).getTime() - preferred) ? slot : best\n  );\n}\n\nreturn {\n  slot_time: selected.time,\n  slot_id: selected.id || selected.time,\n  duration: selected.duration || parseInt($vars.DEFAULT_APPOINTMENT_DURATION) || 30,\n  selection_method: preferredTime ? 'preference' : 'first_available'\n};"
      },
      "id": "select-slot",
      "name": "Select Best Slot",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 300],
      "notes": "CODE NODE 3/8: Slot selection\nSIMPLIFIED: Minimal code (15 lines vs 60+)\nLOGIC: Preference matching or first available\nREMOVED: Fake ML, hardcoded scores"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-slot-available",
      "name": "Check: Slot Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2400, 300],
      "notes": "NATIVE NODE: Route based on availability\nOUTPUT: True = no slots, False = slot found"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": false,\n  \"error\": \"No available appointments\",\n  \"error_code\": \"NO_AVAILABILITY\",\n  \"retry_after\": $now.plus({days: 7}).toISO(),\n  \"trace_id\": $('Set Validated Data').first().json.trace_id,\n  \"timestamp\": $now.toISO()\n} }}",
        "options": {
          "responseCode": 409
        }
      },
      "id": "error-no-availability",
      "name": "Return: No Availability",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2600, 450],
      "notes": "ERROR RESPONSE: 409 Conflict\nNATIVE NODE: No code\nRETURNS: Retry-after suggestion"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 4/8: Duplicate check (minimal)\nconst duplicates = $vars.recent_bookings || {};\nconst key = `${$('Set Validated Data').first().json.phone_normalized}:${$('Set Validated Data').first().json.email}:${$input.first().json.slot_time}`;\nconst now = Date.now();\n\n// Clean old (5 min window)\nObject.keys(duplicates).forEach(k => {\n  if (now - duplicates[k] > 300000) delete duplicates[k];\n});\n\nif (duplicates[key]) {\n  throw new Error(JSON.stringify({ error: 'DUPLICATE_BOOKING', message: 'Same booking within 5 minutes' }));\n}\n\nduplicates[key] = now;\n$vars.recent_bookings = duplicates;\nreturn $input.first().json;"
      },
      "id": "duplicate-check",
      "name": "Duplicate Prevention",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2600, 300],
      "notes": "CODE NODE 4/8: Duplicate check\nSIMPLIFIED: 10 lines vs 40+\nWINDOW: 5 minutes\nTODO: Migrate to Redis for production"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$vars.SCHEDULING_API_BASE_URL}}/bookings",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "eventTypeId",
              "value": "={{$vars.SCHEDULING_EVENT_TYPE_ID}}"
            },
            {
              "name": "start",
              "value": "={{ $json.slot_time }}"
            },
            {
              "name": "responses",
              "value": "={{ {\n  name: $('Set Validated Data').first().json.name,\n  email: $('Set Validated Data').first().json.email,\n  phone: $('Set Validated Data').first().json.phone_display,\n  notes: $('Set Validated Data').first().json.notes,\n  service_type: $('Set Validated Data').first().json.service_type\n} }}"
            },
            {
              "name": "timeZone",
              "value": "={{ $('Set Validated Data').first().json.timezone }}"
            },
            {
              "name": "metadata",
              "value": "={{ {\n  source: 'aigent_module_02',\n  workflow_version: '1.3.0-simplified',\n  trace_id: $('Set Validated Data').first().json.trace_id,\n  phone_normalized: $('Set Validated Data').first().json.phone_normalized\n} }}"
            }
          ]
        },
        "options": {
          "timeout": "={{parseInt($vars.BOOKING_API_TIMEOUT) || 15000}}"
        }
      },
      "id": "create-booking",
      "name": "Create Booking",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2800, 300],
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetween": 2000,
      "notes": "NATIVE NODE: Create booking\nRETRY: 2 attempts with 2s delay\nTIMEOUT: Configurable via $vars.BOOKING_API_TIMEOUT\nUSES: $vars for all config"
    },
    {
      "parameters": {},
      "id": "marker-notifications-start",
      "name": "‚îÅ‚îÅ‚îÅ 02c: NOTIFICATIONS SEGMENT ‚îÅ‚îÅ‚îÅ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [3000, 300],
      "notes": "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nSEGMENT: 02c - NOTIFICATIONS\n\nPURPOSE: Log booking and send confirmations\n\nFLOW:\n1. Log to Google Sheets (audit trail)\n2. Send Slack notification (staff alert)\n3. Send email confirmation (patient)\n4. Send SMS confirmation (patient)\n5. Merge results\n6. Build success response\n\nOUTPUT: Success response with confirmation status\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{$vars.GOOGLE_SHEET_ID}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{$vars.GOOGLE_SHEET_TAB || 'Appointments'}}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $now.toISO() }}",
            "booking_id": "={{ $json.id || $json.uid }}",
            "patient_name": "={{ $('Set Validated Data').first().json.name }}",
            "patient_email": "={{ $('Set Validated Data').first().json.email }}",
            "patient_phone": "={{ $('Set Validated Data').first().json.phone_normalized }}",
            "service_type": "={{ $('Set Validated Data').first().json.service_type }}",
            "appointment_datetime": "={{ $json.start || $json.startTime }}",
            "timezone": "={{ $('Set Validated Data').first().json.timezone }}",
            "duration_minutes": "={{ $('Select Best Slot').first().json.duration }}",
            "status": "SCHEDULED",
            "trace_id": "={{ $('Set Validated Data').first().json.trace_id }}",
            "workflow_version": "1.3.0-simplified",
            "environment": "={{ $vars.ENVIRONMENT || 'production' }}"
          }
        },
        "options": {}
      },
      "id": "log-to-sheets",
      "name": "Log to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [3200, 200],
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "NATIVE NODE: Audit logging\nSHARED CONFIG: Uses $vars.GOOGLE_SHEET_ID from Module 01\nTAB: Separate 'Appointments' tab\nNON-BLOCKING: continueOnFail enabled"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$vars.NOTIFICATION_WEBHOOK_URL}}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "=üìÖ **New Appointment Booked**\n\nüë§ **Patient:** {{ $('Set Validated Data').first().json.name }}\nüìß **Email:** {{ $('Set Validated Data').first().json.email }}\nüì± **Phone:** {{ $('Set Validated Data').first().json.phone_display }}\n\nüè• **Service:** {{ $('Set Validated Data').first().json.service_type }}\nüìÖ **Time:** {{ $now.constructor.fromISO($json.start || $json.startTime).toFormat('EEE, MMM d \\\\at h:mm a') }}\nüåç **Timezone:** {{ $('Set Validated Data').first().json.timezone }}\n‚è±Ô∏è **Duration:** {{ $('Select Best Slot').first().json.duration }} min\n\nüÜî **Booking ID:** {{ ($json.id || $json.uid).substring(0, 8).toUpperCase() }}\nüîç **Trace ID:** {{ $('Set Validated Data').first().json.trace_id }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-slack",
      "name": "Send Slack Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3200, 300],
      "continueOnFail": true,
      "notes": "NATIVE NODE: Slack notification\nSHARED CONFIG: Uses $vars.NOTIFICATION_WEBHOOK_URL from Module 01\nFORMAT: Rich text with booking details\nNON-BLOCKING: continueOnFail enabled"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 5/8: Build email HTML (compact)\nconst booking = $input.first().json;\nconst patient = $('Set Validated Data').first().json;\nconst slot = $('Select Best Slot').first().json;\nconst dt = new Date(booking.start || booking.startTime);\n\nconst html = `<!DOCTYPE html>\n<html>\n<head><meta charset=\"UTF-8\"><style>\nbody{font-family:Arial,sans-serif;line-height:1.6;color:#333;margin:0;padding:0}\n.container{max-width:600px;margin:0 auto;padding:20px}\n.header{background:${$vars.BRAND_PRIMARY_COLOR || '#4F46E5'};color:white;padding:20px;text-align:center;border-radius:8px 8px 0 0}\n.content{background:#f9fafb;padding:30px;border-radius:0 0 8px 8px}\n.detail{margin:15px 0;padding:10px 0;border-bottom:1px solid #e5e7eb}\n.label{font-weight:bold;color:#6b7280;font-size:12px;text-transform:uppercase}\n.value{color:#111827;font-size:16px;margin-top:5px}\n.button{background:${$vars.BRAND_PRIMARY_COLOR || '#4F46E5'};color:white;padding:12px 30px;text-decoration:none;border-radius:6px;display:inline-block;margin:20px 0}\n</style></head>\n<body>\n<div class=\"container\">\n<div class=\"header\"><h1>‚úÖ Appointment Confirmed</h1></div>\n<div class=\"content\">\n<p>Hi ${patient.name.split(' ')[0]},</p>\n<p>Your appointment has been successfully scheduled!</p>\n<div class=\"detail\"><div class=\"label\">Service</div><div class=\"value\">${patient.service_type}</div></div>\n<div class=\"detail\"><div class=\"label\">Date & Time</div><div class=\"value\">${dt.toLocaleDateString('en-US', {weekday:'long',year:'numeric',month:'long',day:'numeric'})} at ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}<br><small>${patient.timezone}</small></div></div>\n<div class=\"detail\"><div class=\"label\">Location</div><div class=\"value\">${$vars.CLINIC_NAME}${$vars.CLINIC_ADDRESS ? '<br>'+$vars.CLINIC_ADDRESS : ''}</div></div>\n<div class=\"detail\"><div class=\"label\">Booking ID</div><div class=\"value\">${(booking.id || booking.uid).substring(0,8).toUpperCase()}</div></div>\n<p style=\"margin-top:30px;font-size:14px;color:#6b7280\"><strong>Need to cancel?</strong><br>Call ${$vars.CLINIC_PHONE} or reply to this email.</p>\n</div>\n</div>\n</body></html>`;\n\nreturn { email_to: patient.email, email_subject: `Appointment Confirmed - ${dt.toLocaleDateString()}`, email_html: html, booking_id: booking.id || booking.uid };"
      },
      "id": "build-email",
      "name": "Build Email HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3200, 400],
      "notes": "CODE NODE 5/8: Email builder\nSIMPLIFIED: Compact HTML (30 lines vs 100+)\nUSES: $vars for clinic info, brand color\nSAFE: Data already sanitized in validation"
    },
    {
      "parameters": {
        "operation": "send",
        "fromEmail": "={{$vars.SENDGRID_FROM_EMAIL}}",
        "toEmail": "={{ $json.email_to }}",
        "subject": "={{ $json.email_subject }}",
        "emailType": "html",
        "message": "={{ $json.email_html }}",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Email Confirmation",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1.1,
      "position": [3400, 400],
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetween": 500,
      "continueOnFail": true,
      "notes": "NATIVE NODE: Email confirmation\nCONFIG: Uses $vars.SENDGRID_FROM_EMAIL\nRETRY: 2 attempts\nNON-BLOCKING: continueOnFail enabled"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 6/8: Build SMS (compact)\nconst booking = $('Create Booking').first().json;\nconst patient = $('Set Validated Data').first().json;\nconst slot = $('Select Best Slot').first().json;\nconst dt = new Date(booking.start || booking.startTime);\n\nconst msg = `Hi ${patient.name.split(' ')[0]},\\n\\nYour ${patient.service_type} appointment is confirmed!\\n\\nüìÖ ${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} at ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}\\nüìç ${$vars.CLINIC_NAME}\\n\\nID: ${(booking.id||booking.uid).substring(0,8).toUpperCase()}\\n\\nQuestions? Call ${$vars.CLINIC_PHONE}\\n\\nReply STOP to unsubscribe`;\n\nif (msg.length > 306) {\n  return { sms_message: msg.substring(0, 303) + '...', to_phone: patient.phone_normalized };\n}\nreturn { sms_message: msg, to_phone: patient.phone_normalized };"
      },
      "id": "build-sms",
      "name": "Build SMS Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3200, 500],
      "notes": "CODE NODE 6/8: SMS builder\nSIMPLIFIED: Compact code (10 lines vs 40+)\nVALIDATES: Length (max 306 chars / 2 segments)\nCOMPLIANCE: Includes STOP opt-out"
    },
    {
      "parameters": {
        "operation": "send",
        "from": "={{$vars.TWILIO_FROM_NUMBER}}",
        "to": "={{ $json.to_phone }}",
        "message": "={{ $json.sms_message }}",
        "options": {}
      },
      "id": "send-sms",
      "name": "Send SMS Confirmation",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1.2,
      "position": [3400, 500],
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetween": 500,
      "continueOnFail": true,
      "notes": "NATIVE NODE: SMS confirmation\nCONFIG: Uses $vars.TWILIO_FROM_NUMBER\nRETRY: 2 attempts\nNON-BLOCKING: continueOnFail enabled"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-confirmations",
      "name": "Merge Confirmations",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [3600, 350],
      "notes": "NATIVE NODE: Merge all confirmation outputs\nMODE: Merge by position (waits for all branches)\nOUTPUT: Combined results from Sheets, Slack, Email, SMS"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "booking_id",
              "value": "={{ $('Create Booking').first().json.id || $('Create Booking').first().json.uid }}"
            },
            {
              "name": "confirmation_number",
              "value": "={{ ($('Create Booking').first().json.id || $('Create Booking').first().json.uid).substring(0, 8).toUpperCase() }}"
            },
            {
              "name": "scheduled_time",
              "value": "={{ $('Create Booking').first().json.start || $('Create Booking').first().json.startTime }}"
            },
            {
              "name": "trace_id",
              "value": "={{ $('Set Validated Data').first().json.trace_id }}"
            }
          ],
          "boolean": [
            {
              "name": "sheets_logged",
              "value": "={{ $('Log to Google Sheets').all().length > 0 }}"
            },
            {
              "name": "slack_sent",
              "value": "={{ $('Send Slack Notification').all().length > 0 }}"
            },
            {
              "name": "email_sent",
              "value": "={{ $('Send Email Confirmation').all().length > 0 }}"
            },
            {
              "name": "sms_sent",
              "value": "={{ $('Send SMS Confirmation').all().length > 0 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "build-response",
      "name": "Build Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [3800, 350],
      "notes": "NATIVE NODE: Build success response\nREPLACED: Complex metadata Code node\nSETS: booking_id, confirmation statuses, trace_id\nSIMPLE: Just Set node expressions"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 7/8: Cache idempotency response (minimal)\nconst idempotencyKey = $('Idempotency Check').first().json.idempotency_key;\n\nif (idempotencyKey) {\n  const cache = $vars.idempotency_cache || {};\n  cache[idempotencyKey] = {\n    response: {\n      success: true,\n      booking_id: $json.booking_id,\n      trace_id: $json.trace_id\n    },\n    timestamp: Date.now()\n  };\n  $vars.idempotency_cache = cache;\n}\n\nreturn $json;"
      },
      "id": "cache-response",
      "name": "Cache Idempotency Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4000, 350],
      "notes": "CODE NODE 7/8: Cache response\nSIMPLIFIED: 10 lines vs 30+\nSTORES: In $vars.idempotency_cache\nPURPOSE: Future duplicate requests return cached response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Appointment booked successfully\",\n  \"data\": {\n    \"appointment_id\": $json.booking_id,\n    \"confirmation_number\": $json.confirmation_number,\n    \"patient_email\": $('Set Validated Data').first().json.email,\n    \"patient_name\": $('Set Validated Data').first().json.name,\n    \"scheduled_time\": $json.scheduled_time,\n    \"timezone\": $('Set Validated Data').first().json.timezone,\n    \"service_type\": $('Set Validated Data').first().json.service_type,\n    \"duration_minutes\": $('Select Best Slot').first().json.duration\n  },\n  \"confirmations\": {\n    \"sheets_logged\": $json.sheets_logged,\n    \"slack_sent\": $json.slack_sent,\n    \"email_sent\": $json.email_sent,\n    \"sms_sent\": $json.sms_sent\n  },\n  \"metadata\": {\n    \"trace_id\": $json.trace_id,\n    \"workflow_version\": \"1.3.0-simplified\",\n    \"timestamp\": $now.toISO()\n  }\n} }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "X-Trace-ID",
                "value": "={{ $json.trace_id }}"
              },
              {
                "name": "X-Workflow-Version",
                "value": "1.3.0-simplified"
              }
            ]
          }
        }
      },
      "id": "return-success",
      "name": "Return Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [4200, 350],
      "notes": "SUCCESS RESPONSE: 200 OK\nNATIVE NODE: No code, just expressions\nRETURNS: Complete booking confirmation with all statuses\nHEADERS: trace_id for debugging"
    },
    {
      "parameters": {
        "jsCode": "// CODE NODE 8/8: Global error handler (minimal)\nconst error = $input.first().json.error || $input.first().json.message || 'Unknown error';\nconst errorData = typeof error === 'string' ? JSON.parse(error) : error;\n\nreturn {\n  success: false,\n  error: errorData.error || 'Request failed',\n  error_code: errorData.error_code || 'UNKNOWN_ERROR',\n  message: errorData.message || error,\n  trace_id: $('Set Validated Data')?.first()?.json?.trace_id || 'BOOK-' + Date.now(),\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "global-error-handler",
      "name": "Global Error Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4000, 600],
      "onError": "continueErrorOutput",
      "notes": "CODE NODE 8/8: Error handler\nPURPOSE: Catch any unhandled errors\nSIMPLIFIED: 10 lines vs 40+\nLOGS: Error details for debugging"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": "={{ $json.error_code === 'RATE_LIMIT_EXCEEDED' ? 429 : ($json.error_code === 'DUPLICATE_BOOKING' ? 409 : 500) }}"
        }
      },
      "id": "return-error",
      "name": "Return Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [4200, 600],
      "notes": "ERROR RESPONSE: Variable status code\nNATIVE NODE: Dynamic status based on error type\nCODES: 429 (rate limit), 409 (duplicate), 500 (other)"
    }
  ],
  "connections": {
    "Webhook: Booking Request": {
      "main": [
        [
          {
            "node": "Rate Limit Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rate Limit Check": {
      "main": [
        [
          {
            "node": "Idempotency Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Idempotency Check": {
      "main": [
        [
          {
            "node": "Validate Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Required Fields": {
      "main": [
        [
          {
            "node": "Return: Validation Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sanitize HTML Characters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize HTML Characters": {
      "main": [
        [
          {
            "node": "Extract Phone Digits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Phone Digits": {
      "main": [
        [
          {
            "node": "Set Validated Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Validated Data": {
      "main": [
        [
          {
            "node": "‚îÅ‚îÅ‚îÅ 02b: SCHEDULING SEGMENT ‚îÅ‚îÅ‚îÅ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚îÅ‚îÅ‚îÅ 02b: SCHEDULING SEGMENT ‚îÅ‚îÅ‚îÅ": {
      "main": [
        [
          {
            "node": "Check Calendar Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Calendar Availability": {
      "main": [
        [
          {
            "node": "Select Best Slot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Best Slot": {
      "main": [
        [
          {
            "node": "Check: Slot Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check: Slot Found?": {
      "main": [
        [
          {
            "node": "Return: No Availability",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Duplicate Prevention",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Duplicate Prevention": {
      "main": [
        [
          {
            "node": "Create Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Booking": {
      "main": [
        [
          {
            "node": "‚îÅ‚îÅ‚îÅ 02c: NOTIFICATIONS SEGMENT ‚îÅ‚îÅ‚îÅ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚îÅ‚îÅ‚îÅ 02c: NOTIFICATIONS SEGMENT ‚îÅ‚îÅ‚îÅ": {
      "main": [
        [
          {
            "node": "Log to Google Sheets",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Email HTML",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build SMS Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Google Sheets": {
      "main": [
        [
          {
            "node": "Merge Confirmations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Notification": {
      "main": [
        [
          {
            "node": "Merge Confirmations",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Build Email HTML": {
      "main": [
        [
          {
            "node": "Send Email Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email Confirmation": {
      "main": [
        [
          {
            "node": "Merge Confirmations",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Build SMS Message": {
      "main": [
        [
          {
            "node": "Send SMS Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send SMS Confirmation": {
      "main": [
        [
          {
            "node": "Merge Confirmations",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge Confirmations": {
      "main": [
        [
          {
            "node": "Build Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Success Response": {
      "main": [
        [
          {
            "node": "Cache Idempotency Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Idempotency Response": {
      "main": [
        [
          {
            "node": "Return Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Error Handler": {
      "main": [
        [
          {
            "node": "Return Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 30
  },
  "staticData": null,
  "tags": [
    {
      "name": "Aigent",
      "id": "aigent"
    },
    {
      "name": "Module-02",
      "id": "module-02"
    },
    {
      "name": "Simplified",
      "id": "simplified"
    },
    {
      "name": "Cloud-Ready",
      "id": "cloud-ready"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-04T00:00:00.000Z",
  "versionId": "1.3.0-simplified",
  "meta": {
    "simplified_version": "1.3.0-simplified",
    "description": "Aigent Module 02: Consult Booking & Scheduling (SIMPLIFIED). Cloud-native workflow using $vars, minimal Code nodes (8 total, down from 23), modular architecture with clear segments, integrated Google Sheets and Slack notifications shared with Module 01. Optimized for n8n Cloud deployment.",
    "author": "Aigent Automation Engineering",
    "license": "Proprietary - Aigent Company",
    "simplifications": {
      "code_nodes_reduced": "23 ‚Üí 8 (65% reduction)",
      "total_nodes": "39 ‚Üí 25 (36% reduction)",
      "native_nodes_used": "IF, Set, String Operations, HTTP Request, Merge",
      "segments": "3 modular segments with NoOp markers",
      "variable_system": "$vars exclusively (n8n Cloud compatible)",
      "integrations_added": "Google Sheets, Slack (shared with Module 01)"
    },
    "code_nodes_remaining": {
      "1": "Rate Limit Check (TODO: migrate to Redis)",
      "2": "Idempotency Check (TODO: migrate to Redis)",
      "3": "Select Best Slot (minimal slot selection logic)",
      "4": "Duplicate Prevention (TODO: migrate to Redis)",
      "5": "Build Email HTML (compact HTML generation)",
      "6": "Build SMS Message (compact SMS with length check)",
      "7": "Cache Idempotency Response (cache successful response)",
      "8": "Global Error Handler (catch-all error formatting)"
    },
    "required_vars": [
      "ALLOWED_ORIGINS",
      "SCHEDULING_API_BASE_URL",
      "SCHEDULING_EVENT_TYPE_ID",
      "CLINIC_TIMEZONE",
      "CLINIC_NAME",
      "CLINIC_PHONE",
      "SENDGRID_FROM_EMAIL",
      "GOOGLE_SHEET_ID",
      "GOOGLE_SHEET_TAB",
      "NOTIFICATION_WEBHOOK_URL"
    ],
    "optional_vars": [
      "RATE_LIMIT_MAX",
      "CALENDAR_API_TIMEOUT",
      "BOOKING_API_TIMEOUT",
      "DEFAULT_APPOINTMENT_DURATION",
      "BRAND_PRIMARY_COLOR",
      "CLINIC_EMAIL",
      "CLINIC_ADDRESS",
      "TWILIO_FROM_NUMBER",
      "ENVIRONMENT"
    ],
    "shared_with_module_01": [
      "ALLOWED_ORIGINS",
      "GOOGLE_SHEET_ID",
      "NOTIFICATION_WEBHOOK_URL",
      "ENVIRONMENT"
    ],
    "performance_targets": {
      "avg_execution_time_ms": 1000,
      "p95_execution_time_ms": 1800,
      "improvement_vs_v1_2": "-500ms (simplified logic, fewer nodes)"
    },
    "deployment_notes": [
      "Import to n8n Cloud",
      "Configure credentials: Cal.com, SendGrid, Twilio, Google Sheets",
      "Set all required $vars in n8n Settings ‚Üí Variables",
      "Reuse Google Sheet and Slack webhook from Module 01",
      "Create 'Appointments' tab in Google Sheet",
      "Test with sample booking request",
      "Monitor execution logs for errors"
    ]
  }
}
