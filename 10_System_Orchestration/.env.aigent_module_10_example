# ============================================================================
# Aigent Module 10 - System Orchestration & Manager Dashboard
# Environment Variables Template
# Version: 1.0.0
# Validated by: Serena + Context7
# ============================================================================
#
# PURPOSE: This module orchestrates health checks, KPI aggregation, alerting,
# and renders a live Manager Dashboard for system-wide visibility.
#
# INSTRUCTIONS:
# 1. Copy this file to your n8n environment configuration
# 2. Replace all placeholder values with your actual settings
# 3. NEVER commit the actual .env file to version control
# 4. Test health checks for all modules before production deployment
# 5. Configure alert channels (Slack/Email) for system notifications
#
# ============================================================================

# ----------------------------------------------------------------------------
# CORE CONFIGURATION
# ----------------------------------------------------------------------------

# Brand name (displayed in dashboard header)
BRAND_NAME=Aigent Universal Clinic

# n8n instance identifier
N8N_INSTANCE_ID=production-001

# Timezone for scheduling and timestamps
TIMEZONE=America/New_York

# HIPAA mode (enables signed URLs for dashboard, restricted access)
# Options: true, false
HIPAA_MODE=true

# ----------------------------------------------------------------------------
# SCHEDULING
# ----------------------------------------------------------------------------

# Manager orchestration schedule (cron expression)
# Examples:
# - Every 15 minutes: */15 * * * *
# - Every hour: 0 * * * *
# - Daily at 6 AM: 0 6 * * *
MANAGER_SCHEDULE_CRON=*/15 * * * *

# ----------------------------------------------------------------------------
# HEALTH CHECK CONFIGURATION
# ----------------------------------------------------------------------------

# Error threshold (modules with errors >= threshold marked as degraded)
ERROR_THRESHOLD=5

# Health check timeout (milliseconds)
HEALTH_CHECK_TIMEOUT_MS=10000

# ----------------------------------------------------------------------------
# MODULE ENDPOINTS & TOGGLES
# ----------------------------------------------------------------------------

# Module 01: Intake & Lead Capture
ENABLED_01_INTAKE=true
MODULE_01_ENDPOINT=https://n8n.yourclinic.com/webhook/intake-lead
MODULE_01_HEALTH=https://n8n.yourclinic.com/webhook/intake-lead/health

# Module 02: Consult Booking
ENABLED_02_BOOKING=true
MODULE_02_ENDPOINT=https://n8n.yourclinic.com/webhook/consult-booking
MODULE_02_HEALTH=https://n8n.yourclinic.com/webhook/consult-booking/health

# Module 03: Telehealth Session
ENABLED_03_TELEHEALTH=true
MODULE_03_ENDPOINT=https://n8n.yourclinic.com/webhook/telehealth-session
MODULE_03_HEALTH=https://n8n.yourclinic.com/webhook/telehealth-session/health

# Module 04: Billing & Payments
ENABLED_04_BILLING=true
MODULE_04_ENDPOINT=https://n8n.yourclinic.com/webhook/billing-payment
MODULE_04_HEALTH=https://n8n.yourclinic.com/webhook/billing-payment/health

# Module 05: Followup & Retention
ENABLED_05_FOLLOWUP=true
MODULE_05_ENDPOINT=https://n8n.yourclinic.com/webhook/followup-campaign
MODULE_05_HEALTH=https://n8n.yourclinic.com/webhook/followup-campaign/health

# Module 06: Document Capture & OCR
ENABLED_06_OCR=true
MODULE_06_ENDPOINT=https://n8n.yourclinic.com/webhook/document-capture
MODULE_06_HEALTH=https://n8n.yourclinic.com/webhook/document-capture/health

# Module 07: Analytics Dashboard
ENABLED_07_ANALYTICS=true
MODULE_07_ENDPOINT=https://n8n.yourclinic.com/webhook/07-analytics-ingest
MODULE_07_HEALTH=https://n8n.yourclinic.com/webhook/07-analytics-ingest/health

# Module 08: Messaging Omnichannel
ENABLED_08_MESSAGING=true
MODULE_08_ENDPOINT=https://n8n.yourclinic.com/webhook/messaging-hub-v1
MODULE_08_HEALTH=https://n8n.yourclinic.com/webhook/messaging-hub-v1/health

# Module 09: Compliance & Audit
ENABLED_09_COMPLIANCE=true
MODULE_09_ENDPOINT=https://n8n.yourclinic.com/webhook/aigent-audit-log
MODULE_09_HEALTH=https://n8n.yourclinic.com/webhook/aigent-audit-log/health

# ⚠️ HEALTH CHECK ENDPOINTS:
# If modules don't have dedicated /health endpoints, Module 10 will use
# n8n API to query workflow execution status (requires N8N_API_TOKEN).

# ----------------------------------------------------------------------------
# N8N API CONFIGURATION (For Workflow Status Queries)
# ----------------------------------------------------------------------------

# n8n API base URL
# Default: http://localhost:5678/api/v1
# Production: Use your n8n instance URL
N8N_API_BASE=http://localhost:5678/api/v1

# n8n API token (from user settings)
# Generate at: n8n UI → Settings → API → Create API Key
N8N_API_TOKEN=your-n8n-api-token-here

# ⚠️ N8N API USAGE:
# Used to query workflow execution history for modules without health endpoints.
# Query: GET /workflows/{workflow_id}/executions?limit=100&status=error&startedAfter={24h_ago}
# Count error executions = errors_24h for health calculation.

# ----------------------------------------------------------------------------
# DASHBOARD STORAGE CONFIGURATION
# ----------------------------------------------------------------------------

# Storage backend for dashboard HTML
# Options: s3, google_drive
DASHBOARD_STORAGE=s3

# Signed URL TTL (seconds)
# Time-limited access to dashboard (applies when HIPAA_MODE=true)
# Default: 3600 seconds (1 hour)
SIGNED_URL_TTL_SECONDS=3600

# Anonymize dashboard (hide sensitive data like IPs, names)
# Options: true, false
ANONYMIZE_DASHBOARD=false

# ----------------------------------------------------------------------------
# AWS S3 CONFIGURATION (If DASHBOARD_STORAGE=s3)
# ----------------------------------------------------------------------------

# AWS Credential ID (from n8n Credentials page)
AWS_CREDENTIAL_ID=17

# S3 bucket for dashboard storage
S3_DASHBOARD_BUCKET=aigent-dashboards

# S3 region
S3_REGION=us-east-1

# ⚠️ S3 SETUP CHECKLIST:
# [ ] S3 bucket created with private ACL
# [ ] Bucket encryption enabled (AES256)
# [ ] IAM user with PutObject, GetObject permissions
# [ ] If HIPAA_MODE=true, use signed URLs (automatic)

# ----------------------------------------------------------------------------
# GOOGLE DRIVE CONFIGURATION (If DASHBOARD_STORAGE=google_drive)
# ----------------------------------------------------------------------------

# Google Drive Credential ID
GOOGLE_DRIVE_CREDENTIAL_ID=22

# Google Drive folder ID (from URL)
# https://drive.google.com/drive/folders/{FOLDER_ID}
GOOGLE_DRIVE_FOLDER_ID=your-folder-id-here

# ⚠️ GOOGLE DRIVE SETUP:
# [ ] OAuth2 credential configured in n8n
# [ ] Folder created with restricted access (if HIPAA_MODE)
# [ ] Sharing permissions set appropriately

# ----------------------------------------------------------------------------
# ALERT CONFIGURATION
# ----------------------------------------------------------------------------

# Slack webhook URL for alerts
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T.../B.../XXX...

# Email address for alerts
ALERT_EMAIL=admin@yourclinic.com,director@yourclinic.com

# SendGrid API Key (for email alerts)
SENDGRID_API_KEY=SG.your-sendgrid-api-key

# SendGrid from email
SENDGRID_FROM_EMAIL=alerts@yourclinic.com

# ⚠️ ALERT TRIGGERS:
# Alerts sent when:
# - Any module status = down
# - Module errors_24h >= ERROR_THRESHOLD (degraded)
# - Missing required environment variables
# - Dependency graph broken (critical path interrupted)
# - KPI thresholds breached (if configured)

# ----------------------------------------------------------------------------
# ANALYTICS DATA SOURCE (MODULE 07)
# ----------------------------------------------------------------------------

# Google Sheets Credential ID
GOOGLE_SHEETS_CREDENTIAL_ID=6

# Google Sheet ID (from Module 07 Analytics output)
GOOGLE_SHEET_ID=your-analytics-sheet-id

# Sheet tab name for KPI summary
GOOGLE_SHEET_TAB_KPI=KPI_Summary

# ⚠️ KPI DATA SOURCE:
# Module 10 reads headline KPIs from Module 07's output sheet.
# Expected columns: metric_name, period, value, timestamp
# Example rows:
# | leads       | 24h | 15   | 2025-10-30T12:00:00Z |
# | bookings    | 24h | 8    | 2025-10-30T12:00:00Z |
# | revenue_usd | 24h | 1200 | 2025-10-30T12:00:00Z |

# ----------------------------------------------------------------------------
# KPI THRESHOLDS (Optional - JSON Format)
# ----------------------------------------------------------------------------

# KPI threshold configuration (JSON string)
# Alerts triggered when metrics fall below thresholds
# Format: {"min_leads_24h": 10, "min_lead_to_booking_rate": 0.30, "min_nps": 7.0}
KPI_THRESHOLDS_JSON={"min_leads_24h": 10, "min_lead_to_booking_rate": 0.30, "min_nps": 7.0}

# ⚠️ KPI THRESHOLD EXAMPLES:
# - min_leads_24h: Minimum daily leads (e.g., 10)
# - min_lead_to_booking_rate: Minimum conversion rate (e.g., 0.30 = 30%)
# - min_booking_show_rate: Minimum show rate (e.g., 0.75 = 75%)
# - min_revenue_24h_usd: Minimum daily revenue (e.g., 500.00)
# - min_nps: Minimum NPS score (e.g., 7.0)

# ----------------------------------------------------------------------------
# REMOTE CONFIGURATION (Optional)
# ----------------------------------------------------------------------------

# Remote config URL (optional)
# JSON endpoint with additional configuration (feature flags, thresholds, etc.)
# Example: https://config.yourclinic.com/aigent-manager.json
CONFIG_URL=

# ⚠️ REMOTE CONFIG FORMAT:
# {
#   "feature_flags": {
#     "enable_predictive_alerts": true,
#     "enable_auto_remediation": false
#   },
#   "thresholds": {
#     "error_threshold": 5,
#     "health_check_timeout_ms": 10000
#   },
#   "module_overrides": {
#     "01_intake": {
#       "enabled": true,
#       "endpoint": "https://..."
#     }
#   }
# }

# ----------------------------------------------------------------------------
# COMPLIANCE ENDPOINT (MODULE 09)
# ----------------------------------------------------------------------------

# Compliance audit endpoint (for error logging)
COMPLIANCE_ENDPOINT=https://n8n.yourclinic.com/webhook/aigent-audit-log

# ⚠️ COMPLIANCE INTEGRATION:
# Module 10 posts significant events to Module 09:
# - orchestration_start (every run)
# - orchestration_error (on failures)
# - orchestration_complete (every successful run)
# - module_health_changed (status transitions)

# ----------------------------------------------------------------------------
# REQUIRED CREDENTIALS (BY MODULE)
# ----------------------------------------------------------------------------

# HubSpot CRM (Modules 01-05, 08)
HUBSPOT_CREDENTIAL_ID=1

# Cal.com (Module 02)
CALCOM_API_KEY=your-cal-api-key

# Zoom (Module 03)
ZOOM_CREDENTIAL_ID=7

# Stripe (Module 04)
STRIPE_CREDENTIAL_ID=2

# Square (Module 04 - alternative)
# SQUARE_CREDENTIAL_ID=24

# SendGrid (Modules 05, 08)
SENDGRID_CREDENTIAL_ID=11

# Twilio (Modules 05, 08)
TWILIO_CREDENTIAL_ID=8

# OCR Provider (Module 06)
# Options: Mistral, Gemini, ABBYY, Tesseract, AWS Textract
MISTRAL_CREDENTIAL_ID=19
# GEMINI_CREDENTIAL_ID=20
# ABBYY_CREDENTIAL_ID=21

# PostgreSQL (Module 09 - if LOG_PRIMARY=postgres)
POSTGRES_CREDENTIAL_ID=15

# ⚠️ CREDENTIAL VALIDATION:
# Module 10 validates that required credentials are configured for enabled modules.
# Missing credentials trigger critical alerts.

# ----------------------------------------------------------------------------
# CONTROL ENDPOINTS
# ----------------------------------------------------------------------------

# Control webhook path: /manager/control
# Accepts POST with JSON body:
#
# START ALL MODULES:
# {"action": "start"}
#
# STOP ALL MODULES:
# {"action": "stop"}
#
# RUN SYNTHETIC TEST:
# {"action": "test"}
#
# RELOAD CONFIGURATION:
# {"action": "reload-config"}

# ⚠️ CONTROL ENDPOINT USAGE:
# curl -X POST https://n8n.yourclinic.com/webhook/manager/control \
#   -H "Content-Type: application/json" \
#   -d '{"action": "test"}'

# ----------------------------------------------------------------------------
# OBSERVABILITY & MONITORING
# ----------------------------------------------------------------------------

# Enable debug mode
DEBUG_MODE=false

# Save execution data
SAVE_EXECUTION_DATA=all

# Support email
SUPPORT_EMAIL=support@yourclinic.com

# Workflow version
WORKFLOW_VERSION=1.0.0

# Enable performance tracking
ENABLE_PERFORMANCE_TRACKING=true

# Target execution time (milliseconds)
# Module 10 target: <5000ms (health checks + dashboard render)
TARGET_EXECUTION_TIME_MS=5000

# ----------------------------------------------------------------------------
# ADVANCED FEATURES (Future Enhancements)
# ----------------------------------------------------------------------------

# Enable predictive alerts (ML-based anomaly detection)
ENABLE_PREDICTIVE_ALERTS=false

# Enable auto-remediation (automatically restart failed modules)
ENABLE_AUTO_REMEDIATION=false

# Enable synthetic transactions (periodic end-to-end tests)
ENABLE_SYNTHETIC_TESTS=false

# Synthetic test schedule (cron expression)
# SYNTHETIC_TEST_SCHEDULE=0 */6 * * *

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
#
# SETUP CHECKLIST:
# [ ] All module endpoints configured (MODULE_01_ENDPOINT through MODULE_09_ENDPOINT)
# [ ] Module toggles set (ENABLED_01_INTAKE through ENABLED_09_COMPLIANCE)
# [ ] Dashboard storage configured (S3 or Google Drive)
# [ ] Alert channels configured (Slack and/or Email)
# [ ] KPI data source configured (GOOGLE_SHEET_ID from Module 07)
# [ ] Required credentials validated for enabled modules
# [ ] Health check endpoints configured or n8n API token set
# [ ] Error threshold configured (ERROR_THRESHOLD)
# [ ] Schedule configured (MANAGER_SCHEDULE_CRON)
# [ ] Compliance endpoint configured (COMPLIANCE_ENDPOINT)
#
# TESTING CHECKLIST:
# [ ] Test scheduled execution (wait for cron trigger)
# [ ] Test manual execution (click "Execute Workflow" in n8n)
# [ ] Test control endpoints:
#     [ ] /manager/control {"action": "test"}
#     [ ] /manager/control {"action": "reload-config"}
# [ ] Verify health checks for all modules
# [ ] Verify env validation catches missing credentials
# [ ] Verify dependency graph detection (disable Module 02, check alerts)
# [ ] Verify KPI aggregation from Module 07 sheet
# [ ] Verify alert delivery (Slack + Email)
# [ ] Verify dashboard generation (HTML content)
# [ ] Verify dashboard publish (S3/Drive upload)
# [ ] Verify signed URL generation (if HIPAA_MODE=true)
# [ ] Verify error handler posts to Module 09 (Compliance)
# [ ] Test with missing env var (e.g., unset STRIPE_CREDENTIAL_ID if Module 04 enabled)
# [ ] Test with module down (stop Module 01 workflow, verify alert)
# [ ] Test with high error count (simulate >5 errors in 24h)
# [ ] Verify KPI threshold alerts (set min_leads_24h=100, verify alert if leads < 100)
# [ ] Verify dashboard displays correct system health status
# [ ] Verify trace_id in response headers
# [ ] Verify execution time < 5000ms
#
# MONITORING CHECKLIST:
# [ ] Monitor orchestration execution success rate (>99%)
# [ ] Monitor dashboard generation time (<3000ms)
# [ ] Monitor health check accuracy (compare with actual module status)
# [ ] Monitor alert delivery success (Slack, Email)
# [ ] Track system health trends (healthy, degraded, critical)
# [ ] Review module health history (identify flaky modules)
# [ ] Monitor KPI trends (leads, bookings, revenue, NPS)
# [ ] Track alert volume (tune thresholds if too noisy)
# [ ] Monitor dashboard access (signed URL usage if HIPAA_MODE)
# [ ] Review dependency graph integrity (critical path breaks)
# [ ] Monitor execution time (optimize if exceeding 5000ms)
#
# OPERATIONAL CHECKLIST:
# [ ] Schedule daily review of Manager Dashboard
# [ ] Establish alert response procedures
# [ ] Document module health investigation steps
# [ ] Train staff on dashboard interpretation
# [ ] Review and adjust thresholds quarterly
# [ ] Update module endpoints when workflows change
# [ ] Test disaster recovery (all modules down scenario)
# [ ] Document control endpoint usage for operations team
# [ ] Establish synthetic test schedule (end-to-end validation)
# [ ] Review KPI definitions with business stakeholders
#
# ARCHITECTURE NOTES:
#
# MODULE 10 ROLE IN AIGENT ECOSYSTEM:
# Module 10 sits at the orchestration layer, providing:
# 1. Health monitoring - All modules (01-09)
# 2. Dependency validation - Critical path integrity
# 3. KPI aggregation - Business metrics from Module 07
# 4. Alerting - System-wide notifications
# 5. Dashboard - Visual system status for managers
# 6. Control plane - Start/stop/test operations
#
# DATA FLOW:
# Module 10 → (reads) → Module 07 (Analytics KPIs)
# Module 10 → (monitors) → Modules 01-09 (Health checks)
# Module 10 → (writes) → Module 09 (Compliance events)
# Module 10 → (publishes) → S3/Drive (Dashboard HTML)
# Module 10 → (notifies) → Slack/Email (Alerts)
#
# CRITICAL PATH VALIDATION:
# Module 10 verifies the patient journey remains intact:
# Lead (01) → Booking (02) → Session (03) → Payment (04) → Followup (05)
# Any break in this chain triggers critical alerts.
#
# COMPLIANCE PATH VALIDATION:
# Module 10 verifies PHI events are logged:
# Documents (06) → Compliance (09)
# Messages (08) → Compliance (09)
# Any break triggers alerts for audit trail integrity.
#
# HEALTH CHECK STRATEGY:
# 1. Dedicated /health endpoints (preferred)
# 2. n8n API workflow status (fallback)
# 3. Last execution time + error count = health status
#
# ALERT ESCALATION:
# - Info: No action required
# - Warning: Review within 24 hours
# - Critical: Immediate action required
#
# For support: support@aigent.company
# Documentation: https://docs.aigent.company/templates/module-10-orchestration
# ============================================================================
