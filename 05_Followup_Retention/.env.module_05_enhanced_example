# ═══════════════════════════════════════════════════════════════
# AIGENT MODULE 05: FOLLOWUP & RETENTION - ENVIRONMENT CONFIGURATION
# ═══════════════════════════════════════════════════════════════
# Version: 1.1
# Created: 2025-01-XX
# PHI Level: NONE (marketing automation only, no clinical data)
# Compliance: CAN-SPAM Act, TCPA (SMS regulations)
#
# This module implements multi-touch follow-up sequences with
# wait nodes. Ensure n8n is configured for long-running executions.
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# SECTION 1: WEBHOOK & SECURITY CONFIGURATION
# ───────────────────────────────────────────────────────────────

# Webhook Configuration
# Used by: Node 501 (Webhook Trigger)
# Purpose: Accept follow-up sequence triggers from Module 04
WEBHOOK_URL=https://your-n8n-instance.com/webhook/aigent-followup
ALLOWED_ORIGINS=https://your-frontend.com,https://your-crm.com

# Security: CORS and API authentication
WEBHOOK_SECRET=your-webhook-secret-here-change-in-production

# ───────────────────────────────────────────────────────────────
# SECTION 2: TIMING CONFIGURATION (CRITICAL FOR WAIT NODES)
# ───────────────────────────────────────────────────────────────

# Follow-Up Sequence Timing
# Day-0: Immediate (no wait)
# Day-3: 72 hours after visit
# Day-7: 96 hours after Day-3 (168 hours total from visit)
# Day-14: 168 hours after Day-7 (336 hours total from visit)

# Day-3 Check-In Delay
# Default: 72 hours (3 days)
# Used by: Node 514 (Wait 72 Hours)
FOLLOWUP_DAY3_DELAY_HOURS=72

# Day-7 Survey Delay
# Default: 96 hours (4 days after Day-3, 7 days total from visit)
# Used by: Node 522 (Wait 96 Hours)
FOLLOWUP_DAY7_DELAY_HOURS=96

# Day-14 Rebooking Delay
# Default: 168 hours (7 days after Day-7, 14 days total from visit)
# Used by: Node 530 (Wait 168 Hours)
FOLLOWUP_DAY14_DELAY_HOURS=168

# Accelerated Timing (for urgent care or time-sensitive specialties)
# Uncomment to override defaults:
# FOLLOWUP_DAY3_DELAY_HOURS=24   # Day-1 check-in
# FOLLOWUP_DAY7_DELAY_HOURS=72   # Day-4 survey
# FOLLOWUP_DAY14_DELAY_HOURS=168 # Day-11 rebooking

# Extended Timing (for specialty care or chronic conditions)
# Uncomment to override defaults:
# FOLLOWUP_DAY3_DELAY_HOURS=168  # Day-7 check-in
# FOLLOWUP_DAY7_DELAY_HOURS=168  # Day-14 survey
# FOLLOWUP_DAY14_DELAY_HOURS=384 # Day-30 rebooking

# ───────────────────────────────────────────────────────────────
# SECTION 3: N8N WAIT NODE CONFIGURATION (REQUIRED)
# ───────────────────────────────────────────────────────────────

# CRITICAL: Wait nodes require specific n8n configuration
# Without these settings, workflows will not resume after wait periods

# Execution Timeout
# Set to -1 (unlimited) for wait nodes to function
# Add to n8n environment variables:
# EXECUTIONS_TIMEOUT=-1

# Database Configuration
# REQUIRED: Use PostgreSQL or MySQL (NOT SQLite)
# SQLite does not persist wait node state reliably
# Example PostgreSQL configuration:
# DB_TYPE=postgresdb
# DB_POSTGRESDB_HOST=localhost
# DB_POSTGRESDB_PORT=5432
# DB_POSTGRESDB_DATABASE=n8n
# DB_POSTGRESDB_USER=n8n_user
# DB_POSTGRESDB_PASSWORD=secure_password

# Webhook IDs for Wait Nodes
# These MUST be unique across all workflows
WAIT_WEBHOOK_DAY3=module-05-wait-day3-unique-id
WAIT_WEBHOOK_DAY7=module-05-wait-day7-unique-id
WAIT_WEBHOOK_DAY14=module-05-wait-day14-unique-id

# ───────────────────────────────────────────────────────────────
# SECTION 4: EMAIL CONFIGURATION (SENDGRID)
# ───────────────────────────────────────────────────────────────

# SendGrid Configuration
# Used by: Nodes 508, 516, 524, 532 (Email sending nodes)
# Credential Name: sendGridApi
# Required: Verified sender email in SendGrid

SENDGRID_FROM_EMAIL=followup@your-clinic.com
SENDGRID_FROM_NAME=Your Clinic Team
SENDGRID_REPLY_TO=support@your-clinic.com

# Email Retry Configuration
# Strategy: 2 attempts, 500ms delay, continueOnFail=true (non-critical)
EMAIL_RETRY_COUNT=2
EMAIL_RETRY_DELAY=500
EMAIL_TIMEOUT=10000
EMAIL_CONTINUE_ON_FAIL=true

# Email Branding
# Logo URL for email header (optional)
EMAIL_LOGO_URL=https://your-clinic.com/logo.png
EMAIL_FOOTER_TEXT=We appreciate your trust in our care.

# ───────────────────────────────────────────────────────────────
# SECTION 5: SMS CONFIGURATION (TWILIO)
# ───────────────────────────────────────────────────────────────

# Twilio Configuration
# Used by: Nodes 511, 519, 527 (SMS sending nodes)
# Credential Name: twilioApi
# Required: Twilio account with SMS-enabled phone number

TWILIO_ACCOUNT_SID=your-account-sid-here
TWILIO_PHONE_NUMBER=+15551234567

# SMS Retry Configuration
# Strategy: 2 attempts, 500ms delay, continueOnFail=true (non-critical)
SMS_RETRY_COUNT=2
SMS_RETRY_DELAY=500
SMS_TIMEOUT=10000
SMS_CONTINUE_ON_FAIL=true

# SMS Feature Toggle
# Set to false to disable all SMS touches (email-only sequence)
ENABLE_SMS_TOUCHES=true

# TCPA Compliance (US SMS regulations)
# Ensure you have patient consent before sending SMS
TCPA_CONSENT_REQUIRED=true
SMS_OPT_OUT_MESSAGE=Reply STOP to unsubscribe

# ───────────────────────────────────────────────────────────────
# SECTION 6: CLINIC CONFIGURATION
# ───────────────────────────────────────────────────────────────

# Clinic Information
# Used throughout all touchpoints for personalization
CLINIC_NAME=Your Clinic Name
CLINIC_WEBSITE=https://your-clinic.com
CLINIC_PHONE=+15551234567
CLINIC_ADDRESS=123 Main St, City, State 12345

# Business Hours (for contact messaging)
CLINIC_HOURS=Mon-Fri: 8am-6pm, Sat: 9am-2pm

# ───────────────────────────────────────────────────────────────
# SECTION 7: SURVEY CONFIGURATION
# ───────────────────────────────────────────────────────────────

# Survey Provider
# Options: typeform, google_forms, surveymonkey, jotform
SURVEY_PROVIDER=typeform

# Survey Link Configuration
# Base URL with parameters appended automatically
# Parameters added: email, patient_id, trace_id
SURVEY_BASE_URL=https://form.typeform.com/to/YOUR_FORM_ID

# Typeform Configuration
TYPEFORM_FORM_ID=YOUR_FORM_ID
TYPEFORM_API_KEY=tfp_your_api_key_here

# Google Forms Configuration (if using Google Forms)
# SURVEY_BASE_URL=https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform

# Survey Questions (for reference - configure in survey provider)
# 1. NPS Question: "How likely are you to recommend us? (0-10)"
#    - Type: Opinion Scale (0-10)
#    - Field name: nps_score
# 2. Feedback Question: "What could we improve?"
#    - Type: Long Text
#    - Field name: feedback_text
# 3. Hidden Fields: email, patient_id, trace_id

# ───────────────────────────────────────────────────────────────
# SECTION 8: REBOOKING CONFIGURATION
# ───────────────────────────────────────────────────────────────

# Rebooking Link
# URL for Day-14 rebooking CTA button
# Parameters added automatically: patient_id, utm_source, utm_medium, utm_campaign, trace_id
REBOOKING_LINK=https://your-booking-system.com/book

# Rebooking Campaign Tracking
# UTM parameters for analytics
UTM_SOURCE=followup
UTM_MEDIUM=email
UTM_CAMPAIGN_DAY14=day14_rebook

# ───────────────────────────────────────────────────────────────
# SECTION 9: RETRY LOGIC CONFIGURATION
# ───────────────────────────────────────────────────────────────

# Global Retry Settings
# Applied to all email and SMS operations

# Email Retry Settings
# Used by: All email sending nodes (508, 516, 524, 532)
EMAIL_API_RETRY_COUNT=2
EMAIL_API_RETRY_DELAY_MS=500
EMAIL_API_TIMEOUT_MS=10000

# SMS Retry Settings
# Used by: All SMS sending nodes (511, 519, 527)
SMS_API_RETRY_COUNT=2
SMS_API_RETRY_DELAY_MS=500
SMS_API_TIMEOUT_MS=10000

# Graceful Degradation
# Continue workflow even if email/SMS fails (set to true)
# Critical for long-running wait node workflows
CONTINUE_ON_EMAIL_FAIL=true
CONTINUE_ON_SMS_FAIL=true

# ───────────────────────────────────────────────────────────────
# SECTION 10: ENGAGEMENT TRACKING
# ───────────────────────────────────────────────────────────────

# Touch Tracking
# Record which touches were sent successfully
ENABLE_TOUCH_TRACKING=true

# Engagement Analytics
# Track email opens, clicks, SMS delivery status
# Requires SendGrid/Twilio webhooks configured
ENABLE_ENGAGEMENT_ANALYTICS=false
ENGAGEMENT_WEBHOOK_URL=https://your-n8n-instance.com/webhook/engagement-tracking

# ───────────────────────────────────────────────────────────────
# SECTION 11: PERFORMANCE & OBSERVABILITY
# ───────────────────────────────────────────────────────────────

# Execution Time Tracking
# Used by: Node 533 (Execution Tracking & Success Response)
ENABLE_EXECUTION_TRACKING=true

# Performance Thresholds (milliseconds)
# Note: Only measures initial setup time, not wait time
PERFORMANCE_FAST_THRESHOLD=1000
PERFORMANCE_SLOW_THRESHOLD=3000

# Target: <2000ms for initial sequence setup
PERFORMANCE_TARGET_MS=2000

# Logging Configuration
LOG_LEVEL=info
LOG_FORMAT=json
LOG_DESTINATION=console

# Monitoring Integration (Framework Ready)
ENABLE_DATADOG_MONITORING=false
DATADOG_API_KEY=your-datadog-api-key
DATADOG_SERVICE_NAME=aigent-followup-retention

# ───────────────────────────────────────────────────────────────
# SECTION 12: COMPLIANCE & OPT-OUT
# ───────────────────────────────────────────────────────────────

# CAN-SPAM Act Compliance (Email)
# All marketing emails must include unsubscribe link

OPTOUT_LINK_ENABLED=true
OPTOUT_LINK_URL=https://your-clinic.com/unsubscribe?patient_id={{patient_id}}

# Email Footer with Opt-Out
# Automatically appended to all emails
EMAIL_FOOTER_OPTOUT=To unsubscribe from follow-up emails, click here: {{OPTOUT_LINK_URL}}

# TCPA Compliance (SMS)
# SMS opt-out must be honored immediately
SMS_OPTOUT_KEYWORDS=STOP,UNSUBSCRIBE,CANCEL,END,QUIT
SMS_OPTOUT_CONFIRMATION=You have been unsubscribed from SMS notifications.

# ───────────────────────────────────────────────────────────────
# SECTION 13: DATA CONTRACT & MODULE INTEGRATION
# ───────────────────────────────────────────────────────────────

# Data Contract 05: followup_feedback.json
# Output schema version
DATA_CONTRACT_VERSION=1.0

# Module Integration Configuration
# Upstream Modules (data sources)
MODULE_04_ENABLED=true
MODULE_04_WEBHOOK_URL=https://your-n8n-instance.com/webhook/aigent-followup

# Downstream Modules (data consumers)
MODULE_07_ENABLED=true
MODULE_09_ENABLED=true

# Webhook URLs for downstream notifications
MODULE_07_WEBHOOK_URL=https://your-n8n-instance.com/webhook/analytics
MODULE_09_WEBHOOK_URL=https://your-n8n-instance.com/webhook/audit

# ───────────────────────────────────────────────────────────────
# SECTION 14: TESTING & DEVELOPMENT
# ───────────────────────────────────────────────────────────────

# Test Mode
# CRITICAL: Set to false in production
TEST_MODE=false

# Test Email/SMS Override
# When TEST_MODE=true, all messages sent to these addresses
TEST_EMAIL_OVERRIDE=test@yourclinic.com
TEST_PHONE_OVERRIDE=+15559999999

# Wait Node Acceleration (Development Only)
# Override wait times for faster testing
# CAUTION: Only use in development - never in production
TEST_ACCELERATE_WAITS=false
TEST_DAY3_DELAY_MINUTES=5
TEST_DAY7_DELAY_MINUTES=10
TEST_DAY14_DELAY_MINUTES=15

# ───────────────────────────────────────────────────────────────
# VALIDATION CHECKLIST
# ───────────────────────────────────────────────────────────────
# Before deploying to production, verify:
#
# [ ] n8n execution timeout disabled (EXECUTIONS_TIMEOUT=-1)
# [ ] PostgreSQL or MySQL database configured (not SQLite)
# [ ] All wait webhook IDs are unique
# [ ] SendGrid sender email verified
# [ ] Twilio phone number SMS-enabled
# [ ] TCPA consent obtained for SMS recipients
# [ ] CAN-SPAM unsubscribe link functional
# [ ] Survey form created with correct fields (email, patient_id, trace_id, nps_score, feedback_text)
# [ ] Survey webhook configured to receive responses
# [ ] Rebooking link tested and functional
# [ ] Test mode disabled (TEST_MODE=false)
# [ ] Email templates reviewed for branding and accuracy
# [ ] SMS message lengths under 160 characters
# [ ] Retry logic tested for transient failures
# [ ] Performance monitoring configured
# [ ] Wait node resumption tested (critical!)
# [ ] Database backups enabled for long-running workflows
#
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# CAN-SPAM ACT COMPLIANCE NOTES
# ───────────────────────────────────────────────────────────────
#
# This module sends marketing emails and must comply with the
# CAN-SPAM Act (US federal law for commercial email).
#
# Key Requirements Implemented:
# 1. Accurate "From" information (sender email verified)
# 2. Truthful subject lines (no deceptive messaging)
# 3. Clear identification as marketing messages
# 4. Valid physical address in footer (configure CLINIC_ADDRESS)
# 5. Opt-out mechanism (unsubscribe link in all emails)
# 6. Honor opt-out requests within 10 business days
#
# Penalties: Up to $46,517 per violation
#
# Reference: https://www.ftc.gov/tips-advice/business-center/guidance/can-spam-act-compliance-guide-business
#
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# TCPA COMPLIANCE NOTES (SMS REGULATIONS)
# ───────────────────────────────────────────────────────────────
#
# This module sends SMS messages and must comply with the
# Telephone Consumer Protection Act (TCPA).
#
# Key Requirements:
# 1. Prior express written consent required
# 2. Opt-out mechanism (STOP keyword support)
# 3. Clear identification of sender
# 4. Respect quiet hours (8am-9pm local time)
# 5. Maintain consent records for 4 years
#
# Best Practices:
# - Only send SMS to patients who explicitly opted in
# - Honor STOP requests immediately (within minutes)
# - Include opt-out instructions in first message
# - Send confirmation when patient opts out
#
# Penalties: $500-$1,500 per violation
#
# Reference: https://www.fcc.gov/consumers/guides/stop-unwanted-robocalls-and-texts
#
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# WAIT NODE TROUBLESHOOTING GUIDE
# ───────────────────────────────────────────────────────────────
#
# Common Issues:
#
# 1. Workflow stops at wait node and never resumes
#    - Verify EXECUTIONS_TIMEOUT=-1 in n8n settings
#    - Check database type (must be PostgreSQL or MySQL, not SQLite)
#    - Ensure wait webhook IDs are unique
#    - Check n8n logs: docker logs n8n_container | grep wait
#
# 2. Workflow fails to resume after n8n restart
#    - Database persistence issue - check DB_TYPE configuration
#    - Verify database connection is stable
#    - Check execution history in n8n UI for stuck executions
#
# 3. Wait times not respected (resumes too early/late)
#    - Check FOLLOWUP_*_DELAY_HOURS environment variables
#    - Verify wait node configuration references correct env vars
#    - Check server time zone matches expected time zone
#
# 4. Multiple workflows resume simultaneously
#    - Wait webhook IDs are not unique - change WAIT_WEBHOOK_* values
#    - Each wait node across ALL workflows needs unique webhook ID
#
# 5. Email/SMS not sending after wait
#    - Check SendGrid/Twilio API credentials haven't expired
#    - Verify retry logic is functioning (check logs)
#    - Ensure CONTINUE_ON_*_FAIL=true for graceful degradation
#
# Debug Mode:
# Set LOG_LEVEL=debug to see detailed wait node state transitions
#
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# PERFORMANCE OPTIMIZATION TIPS
# ───────────────────────────────────────────────────────────────
#
# 1. Database Performance
#    - Use connection pooling for PostgreSQL
#    - Regular database maintenance (VACUUM, ANALYZE)
#    - Monitor database size (wait nodes create many execution records)
#
# 2. Email/SMS Delivery
#    - SendGrid: Use templates for faster rendering
#    - Twilio: Use messaging service SIDs for better deliverability
#    - Batch touch preparation when possible
#
# 3. Execution Cleanup
#    - Configure n8n to delete old executions automatically
#    - Retention: 30 days for successful, 90 days for failed
#    - Add to n8n environment:
#      EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
#      EXECUTIONS_DATA_PRUNE=true
#      EXECUTIONS_DATA_MAX_AGE=168  # 7 days in hours
#
# 4. Monitoring
#    - Track wait node resumption success rate
#    - Monitor email/SMS delivery rates
#    - Alert on failed touch deliveries
#    - Dashboard: touch completion rate by day (Day-0, Day-3, Day-7, Day-14)
#
# ═══════════════════════════════════════════════════════════════
