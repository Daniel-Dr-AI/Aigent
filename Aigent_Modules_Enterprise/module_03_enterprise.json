{
  "name": "Aigent_Module_03_Enterprise_Telehealth_Session",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "telehealth-session",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "={{$env.ALLOWED_ORIGINS || '*'}}"
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300],
      "webhookId": "{{$env.WEBHOOK_ID}}",
      "notes": "ENTERPRISE: HIPAA-compliant video session creation"
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: API Key Authentication\nconst input = $input.item.json;\nconst headers = input.headers || {};\n\nconst apiKeyEnabled = $env.API_KEY_ENABLED === 'true';\nconst expectedApiKey = $env.API_KEY;\n\nif (apiKeyEnabled && expectedApiKey) {\n  const providedKey = headers['x-api-key'] || headers['authorization']?.replace('Bearer ', '');\n  \n  if (!providedKey || providedKey !== expectedApiKey) {\n    return {\n      _auth_failed: true,\n      success: false,\n      error: 'Unauthorized: Invalid or missing API key',\n      timestamp: new Date().toISOString()\n    };\n  }\n}\n\nreturn { ...input, _auth_passed: true };"
      },
      "id": "auth-check",
      "name": "API Key Authentication",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300],
      "notes": "ENTERPRISE: API key validation"
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "auth-check",
              "leftValue": "={{ !$json._auth_failed }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "auth-router",
      "name": "Auth Check",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [600, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 401
        }
      },
      "id": "return-auth-error",
      "name": "Return Unauthorized",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: Rich execution metadata\nconst executionStartTime = Date.now();\nconst input = $input.item.json;\nconst headers = input.headers || {};\n\nconst clientIP = headers['x-forwarded-for']?.split(',')[0].trim() || \n                 headers['x-real-ip'] || 'unknown';\n\nconst traceId = `SESSION-${executionStartTime}-${Math.random().toString(36).substring(7)}`;\n\nlet body = input.body || {};\nif (Object.keys(body).length === 0 && input.booking_id) {\n  body = {\n    booking_id: input.booking_id,\n    patient_email: input.patient_email,\n    scheduled_time: input.scheduled_time,\n    duration_minutes: input.duration_minutes\n  };\n}\n\nreturn {\n  body: body,\n  _metadata: {\n    trace_id: traceId,\n    execution_start_time: executionStartTime,\n    client_ip: clientIP,\n    workflow_version: 'enterprise-1.0.0',\n    module: 'telehealth_session',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "add-metadata",
      "name": "Add Execution Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 240],
      "notes": "ENTERPRISE: Comprehensive metadata"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "id": "booking-id",
              "leftValue": "={{ $json.body.booking_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "email",
              "leftValue": "={{ $json.body.patient_email }}",
              "rightValue": "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "validate-fields",
      "name": "Enhanced Validation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 240],
      "notes": "ENTERPRISE: Strict validation"
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: PHI masking\nconst body = $input.item.json.body || {};\nconst metadata = $input.item.json._metadata;\n\nconst emailNormalized = (body.patient_email || '').toLowerCase().trim();\n\nconst maskEmail = (email) => {\n  if (!email || !email.includes('@')) return email;\n  const [local, domain] = email.split('@');\n  return local[0] + '***' + (local[local.length-1] || '') + '@' + domain;\n};\n\nreturn {\n  _metadata: metadata,\n  data: {\n    trace_id: metadata.trace_id,\n    booking_id: body.booking_id,\n    patient_email: emailNormalized,\n    scheduled_time: body.scheduled_time || new Date(Date.now() + 3600000).toISOString(),\n    duration_minutes: parseInt(body.duration_minutes) || 30,\n    provider_notes: body.provider_notes || '',\n    client_ip: metadata.client_ip,\n    timestamp: metadata.timestamp\n  },\n  data_masked: {\n    patient_email: maskEmail(emailNormalized),\n    booking_id: body.booking_id\n  }\n};"
      },
      "id": "normalize-data",
      "name": "Normalize & Mask Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 180],
      "notes": "ENTERPRISE: Data processing + PHI masking"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.VIDEO_PLATFORM_API_URL || 'https://api.zoom.us/v2'}}/meetings",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.VIDEO_PLATFORM_API_KEY || 'mock-key'}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "topic",
              "value": "={{ 'Telehealth Session - ' + $json.data.booking_id }}"
            },
            {
              "name": "type",
              "value": 2
            },
            {
              "name": "start_time",
              "value": "={{ $json.data.scheduled_time }}"
            },
            {
              "name": "duration",
              "value": "={{ $json.data.duration_minutes }}"
            },
            {
              "name": "settings",
              "value": "={{ { host_video: true, participant_video: true, join_before_host: false, waiting_room: true, encryption_type: 'enhanced_encryption' } }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "create-meeting",
      "name": "Create Video Meeting",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 180],
      "retryOnFail": true,
      "maxTries": 3,
      "notes": "ENTERPRISE: HIPAA-compliant video (waiting room + encryption)"
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: Extract and secure meeting URLs\nconst meeting = $input.first().json;\nconst normalizedData = $('Normalize & Mask Data').first().json.data;\n\nconst meetingUrl = meeting.join_url || meeting.url || `https://meet.example.com/${Date.now()}`;\nconst meetingId = meeting.id || `MOCK-${Date.now()}`;\n\n// Enterprise: Separate provider and patient URLs for security\nconst providerUrl = meeting.start_url || meetingUrl + '?role=host';\nconst patientUrl = meetingUrl + '?role=participant';\n\nreturn {\n  session_id: normalizedData.trace_id,\n  booking_id: normalizedData.booking_id,\n  meeting_id: meetingId,\n  meeting_url: meetingUrl,\n  patient_url: patientUrl,\n  provider_url: providerUrl,\n  scheduled_start: normalizedData.scheduled_time,\n  duration_minutes: normalizedData.duration_minutes,\n  patient_email: normalizedData.patient_email,\n  client_ip: normalizedData.client_ip,\n  timestamp: normalizedData.timestamp,\n  encryption_enabled: true,\n  waiting_room_enabled: true\n};"
      },
      "id": "extract-urls",
      "name": "Extract Meeting URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 180],
      "notes": "ENTERPRISE: Separate provider/patient URLs + security flags"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{$env.GOOGLE_SHEET_ID}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{$env.GOOGLE_SHEET_TAB || 'Sessions'}}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "session_id": "={{ $json.session_id }}",
            "booking_id": "={{ $json.booking_id }}",
            "meeting_id": "={{ $json.meeting_id }}",
            "patient_email": "={{ $json.patient_email }}",
            "meeting_url": "={{ $json.meeting_url }}",
            "scheduled_start": "={{ $json.scheduled_start }}",
            "duration_minutes": "={{ $json.duration_minutes }}",
            "encryption_enabled": "={{ $json.encryption_enabled }}",
            "waiting_room_enabled": "={{ $json.waiting_room_enabled }}",
            "client_ip": "={{ $json.client_ip }}",
            "status": "SCHEDULED"
          }
        }
      },
      "id": "log-sheets",
      "name": "Log to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1800, 100],
      "retryOnFail": true,
      "maxTries": 3,
      "continueOnFail": true,
      "notes": "ENTERPRISE: Audit logging with security flags"
    },
    {
      "parameters": {
        "operation": "send",
        "fromEmail": "={{$env.SENDGRID_FROM_EMAIL || 'noreply@example.com'}}",
        "toEmail": "={{ $json.patient_email }}",
        "subject": "Your Telehealth Session Link - {{$env.CLINIC_NAME}}",
        "emailType": "text",
        "message": "=Hi,\n\nYour secure telehealth session is ready!\n\nðŸ”— Join Meeting: {{ $json.patient_url }}\n\nðŸ“… Scheduled Time: {{ $json.scheduled_start }}\nâ±ï¸ Duration: {{ $json.duration_minutes }} minutes\n\nðŸ”’ Security Features:\n- End-to-end encryption enabled\n- Waiting room (provider will admit you)\n\nðŸ†” Session ID: {{ $json.session_id.substring(0, 12).toUpperCase() }}\n\nPlease join 5 minutes early. Questions? Call {{$env.CLINIC_PHONE}}\n\nThank you!",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Meeting Link Email",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1.1,
      "position": [1800, 180],
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "disabled": true,
      "notes": "ENTERPRISE: HIPAA-compliant email with security info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.NOTIFICATION_WEBHOOK_URL || 'https://httpbin.org/post'}}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "=ðŸŽ¥ Telehealth Session Created\nðŸ“§ {{ $('Normalize & Mask Data').first().json.data_masked.patient_email }}\nðŸ“… {{ $json.scheduled_start }}\nðŸ”’ Security: Encryption + Waiting Room\nðŸ”— Provider URL: {{ $json.provider_url }}\nðŸ†” {{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-staff",
      "name": "Notify Staff (Masked)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 260],
      "continueOnFail": true,
      "retryOnFail": true,
      "maxTries": 2,
      "notes": "ENTERPRISE: PHI-masked notification with provider URL"
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: Calculate execution time and format response\nconst metadata = $('Normalize & Mask Data').first().json._metadata;\nconst session = $input.item.json;\n\nconst executionDuration = Date.now() - metadata.execution_start_time;\n\nlet performanceCategory = 'fast';\nif (executionDuration >= 2000) performanceCategory = 'slow';\nelse if (executionDuration >= 1000) performanceCategory = 'normal';\n\nreturn {\n  success: true,\n  message: 'Telehealth session created successfully',\n  data: {\n    session_id: session.session_id,\n    meeting_url: session.patient_url,\n    provider_url: session.provider_url,\n    scheduled_start: session.scheduled_start,\n    duration_minutes: session.duration_minutes,\n    security: {\n      encryption_enabled: session.encryption_enabled,\n      waiting_room_enabled: session.waiting_room_enabled\n    },\n    trace_id: session.session_id\n  },\n  metadata: {\n    execution_time_ms: executionDuration,\n    performance: performanceCategory,\n    workflow_version: 'enterprise-1.0.0',\n    timestamp: metadata.timestamp\n  }\n};"
      },
      "id": "format-success",
      "name": "Format Success Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 180],
      "notes": "ENTERPRISE: Rich response with security info"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "X-Workflow-Version",
                "value": "enterprise-1.0.0"
              },
              {
                "name": "X-Execution-Time-Ms",
                "value": "={{ $json.metadata.execution_time_ms }}"
              },
              {
                "name": "X-Trace-Id",
                "value": "={{ $json.data.trace_id }}"
              }
            ]
          }
        }
      },
      "id": "return-success",
      "name": "Return Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2200, 180],
      "notes": "ENTERPRISE: Success with headers"
    },
    {
      "parameters": {
        "jsCode": "// ENTERPRISE: Detailed validation errors\nconst body = $input.item.json.body || {};\nconst errors = [];\n\nif (!body.booking_id) {\n  errors.push('booking_id (required)');\n}\n\nif (!body.patient_email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(body.patient_email)) {\n  errors.push('patient_email (valid email required)');\n}\n\nconst errorMessage = errors.length > 0 \n  ? `Missing or invalid required fields: ${errors.join(', ')}`\n  : 'Please provide booking_id and patient_email';\n\nreturn {\n  success: false,\n  error: errorMessage,\n  validation_errors: errors,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "format-error",
      "name": "Format Validation Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 340],
      "notes": "ENTERPRISE: Detailed field errors"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "return-error",
      "name": "Return Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1400, 340]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{"node": "API Key Authentication"}]]
    },
    "API Key Authentication": {
      "main": [[{"node": "Auth Check"}]]
    },
    "Auth Check": {
      "main": [
        [{"node": "Add Execution Metadata"}],
        [{"node": "Return Unauthorized"}]
      ]
    },
    "Add Execution Metadata": {
      "main": [[{"node": "Enhanced Validation"}]]
    },
    "Enhanced Validation": {
      "main": [
        [{"node": "Normalize & Mask Data"}],
        [{"node": "Format Validation Error"}]
      ]
    },
    "Normalize & Mask Data": {
      "main": [[{"node": "Create Video Meeting"}]]
    },
    "Create Video Meeting": {
      "main": [[{"node": "Extract Meeting URLs"}]]
    },
    "Extract Meeting URLs": {
      "main": [[
        {"node": "Log to Google Sheets"},
        {"node": "Send Meeting Link Email"},
        {"node": "Notify Staff (Masked)"},
        {"node": "Format Success Response"}
      ]]
    },
    "Format Success Response": {
      "main": [[{"node": "Return Success"}]]
    },
    "Format Validation Error": {
      "main": [[{"node": "Return Validation Error"}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "timezone": "America/New_York",
    "saveExecutionProgress": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "tags": [
    {"id": "aigent-enterprise", "name": "Aigent-Enterprise"},
    {"id": "module-03", "name": "Module-03"},
    {"id": "hipaa-ready", "name": "HIPAA-Ready"}
  ],
  "meta": {
    "version": "enterprise-1.0.0",
    "branch": "Enterprise",
    "description": "Aigent Module 03 ENTERPRISE: HIPAA-compliant telehealth session management with encryption, waiting room, PHI masking, and separate provider/patient URLs.",
    "target_users": "Medical practices, telehealth providers, healthcare organizations",
    "features": [
      "API key authentication (optional)",
      "PHI masking in logs/notifications",
      "Client IP tracking",
      "HIPAA-compliant video (encryption + waiting room)",
      "Separate provider and patient URLs",
      "Enhanced validation",
      "Execution time tracking",
      "Response headers",
      "Retry logic (3x on meeting creation)",
      "Security flags in audit log"
    ],
    "security_features": [
      "End-to-end encryption enabled",
      "Waiting room enabled",
      "Separate host/participant URLs",
      "PHI masking in notifications",
      "Client IP tracking"
    ],
    "compliance": {
      "hipaa_ready": true,
      "encryption": "Enhanced encryption for video",
      "waiting_room": "Enabled for provider control",
      "phi_masking": "Email masked in logs",
      "audit_trail": "Full session tracking with security flags"
    },
    "added_from_core": [
      "API key authentication",
      "PHI masking",
      "Enhanced encryption settings",
      "Waiting room requirement",
      "Separate provider/patient URLs",
      "Security flags logging",
      "Execution time tracking",
      "Response headers",
      "Retry logic (3x)",
      "Workflow settings"
    ],
    "required_vars": [
      "GOOGLE_SHEET_ID",
      "VIDEO_PLATFORM_API_URL",
      "VIDEO_PLATFORM_API_KEY"
    ],
    "optional_vars": [
      "API_KEY_ENABLED",
      "API_KEY",
      "ALLOWED_ORIGINS",
      "GOOGLE_SHEET_TAB (default: Sessions)",
      "SENDGRID_FROM_EMAIL",
      "NOTIFICATION_WEBHOOK_URL",
      "CLINIC_NAME",
      "CLINIC_PHONE",
      "WEBHOOK_ID"
    ],
    "performance": {
      "avg_execution_time_ms": 900,
      "p95_execution_time_ms": 1800,
      "node_count": 16,
      "vs_core": "Slightly slower (+50%) due to security enhancements"
    },
    "video_platforms": {
      "supported": ["Zoom", "Google Meet", "Doxy.me"],
      "recommended": "Zoom with Healthcare API",
      "hipaa_requirement": "Must have BAA with video platform provider"
    },
    "notes": "HIPAA-COMPLIANT: Requires BAA with Zoom/video provider. Enhanced encryption and waiting room are mandatory for healthcare use."
  }
}
